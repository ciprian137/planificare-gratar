<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculator GrƒÉtar - Planificator Simplificat</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #c0392b;
            --info-color: #3498db;
            --light-gray: #ecf0f1;
            --medium-gray: #bdc3c7;
            --dark-gray: #7f8c8d;
            --white: #ffffff;
            --shadow: rgba(0, 0, 0, 0.1);
            --shadow-dark: rgba(0, 0, 0, 0.2);
        }
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            color: var(--light-gray);
            line-height: 1.6;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--white);
            border-radius: 20px;
            box-shadow: 0 25px 50px var(--shadow-dark);
            overflow: hidden;
            color: #333;
        }
        .header {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: var(--white);
            padding: 40px 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: float 6s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
        .header h1 {
            margin: 0;
            font-size: 2.8em;
            font-weight: 700;
            text-shadow: 0 3px 6px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1;
        }
        .header p {
            margin: 15px 0;
            font-size: 1.2em;
            color: var(--medium-gray);
            position: relative;
            z-index: 1;
        }
        .action-buttons {
            margin-top: 25px;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            position: relative;
            z-index: 1;
        }
        .action-buttons button {
            background: linear-gradient(135deg, #555, #777);
            color: var(--white);
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }
        .action-buttons button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s ease;
        }
        .action-buttons button:hover::before {
            left: 100%;
        }
        .action-buttons button:hover {
            background: linear-gradient(135deg, #777, #999);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        .content {
            padding: 40px;
        }
        .input-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
            padding: 30px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            box-shadow: 0 8px 25px var(--shadow);
            border: 2px solid rgba(52, 73, 94, 0.1);
        }
        .input-group {
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .input-group label {
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--primary-color);
            font-size: 1.1em;
        }
        .input-group input {
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: var(--white);
            color: #333;
            font-weight: 500;
        }
        .input-group input:focus {
            outline: none;
            border-color: var(--info-color);
            box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.2);
            transform: translateY(-2px);
        }
        .tables-grid-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 35px;
            margin-bottom: 40px;
        }
        .table-section {
            background: linear-gradient(135deg, #f8f9fa, #ffffff);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px var(--shadow);
            border: 2px solid rgba(52, 73, 94, 0.1);
            transition: all 0.3s ease;
        }
        .table-section:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px var(--shadow-dark);
        }
        .table-section h3 {
            margin-top: 0;
            color: var(--primary-color);
            text-align: center;
            font-size: 1.5em;
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--accent-color);
        }
        .add-btn {
            background: linear-gradient(135deg, var(--success-color), #2ecc71);
            color: var(--white);
            border: none;
            padding: 10px 18px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }
        .add-btn:hover {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
        }
        .delete-btn {
            background: linear-gradient(135deg, var(--danger-color), #e74c3c);
            color: var(--white);
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(192, 57, 43, 0.3);
        }
        .delete-btn:hover {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(192, 57, 43, 0.4);
        }
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: var(--white);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 25px var(--shadow);
            border: 2px solid rgba(52, 73, 94, 0.1);
        }
        th, td {
            padding: 15px 12px;
            text-align: left;
            color: #333;
            font-weight: 500;
            border-bottom: 1px solid #e9ecef;
        }
        th {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: var(--white);
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        th .sort-indicator {
            margin-left: 5px;
            font-size: 0.8em;
            vertical-align: middle;
        }
        th::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s ease;
        }
        th:hover::before {
            left: 100%;
        }
        th:hover {
            background: linear-gradient(135deg, #4a5f7a, #3c4f66);
            transform: translateY(-2px);
        }
        tr[draggable="true"] {
            cursor: grab;
            transition: all 0.3s ease;
        }
        tr[draggable="true"]:hover {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            transform: translateX(5px);
            box-shadow: 0 5px 15px var(--shadow);
        }
        tr[draggable="true"]:active {
            cursor: grabbing;
        }
        tr.dragging {
            opacity: 0.6;
            background: linear-gradient(135deg, #e8f4fd, #d1ecf1);
            transform: rotate(2deg);
            box-shadow: 0 10px 30px var(--shadow-dark);
        }
        .drag-over {
            border-bottom: 4px solid var(--info-color) !important;
            background: rgba(52, 152, 219, 0.1);
        }
        .drag-over-top {
            border-top: 4px solid var(--info-color) !important;
            background: rgba(52, 152, 219, 0.1);
        }
        tbody.drag-over {
            border: 3px dashed var(--info-color);
            background: rgba(52, 152, 219, 0.1);
            min-height: 60px;
            display: block;
        }
        .editable-input,
        .price-input,
        .quantity-input,
        .notes-input {
            width: calc(100% - 10px);
            padding: 8px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            background: var(--white);
            color: #333;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .editable-input:focus,
        .price-input:focus,
        .quantity-input:focus,
        .notes-input:focus {
            outline: none;
            border-color: var(--info-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            transform: translateY(-1px);
        }
        .price-input, .quantity-input {
            text-align: center;
            font-weight: 600;
        }
        .total-price {
            font-weight: 700;
            color: var(--success-color);
            font-size: 1.1em;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .quantity {
            font-weight: 700;
            color: var(--accent-color);
            font-size: 1.1em;
        }
        .budget-summary {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: var(--white);
            padding: 35px;
            border-radius: 15px;
            text-align: center;
            margin-top: 30px;
            box-shadow: 0 15px 40px var(--shadow-dark);
            border: 3px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }
        .budget-summary::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: float 8s ease-in-out infinite;
        }
        .budget-summary h3 {
            margin: 0 0 20px 0;
            font-size: 1.8em;
            font-weight: 700;
            color: var(--white);
            position: relative;
            z-index: 1;
        }
        .budget-row {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            font-size: 1.2em;
            color: var(--light-gray);
            font-weight: 500;
            position: relative;
            z-index: 1;
        }
        .remaining-budget {
            font-size: 1.4em;
            font-weight: 700;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 3px solid rgba(255,255,255,0.3);
            color: var(--white);
            position: relative;
            z-index: 1;
        }
        .warning {
            background: linear-gradient(135deg, var(--danger-color), #e74c3c) !important;
            animation: pulse 2s infinite;
            box-shadow: 0 0 30px rgba(192, 57, 43, 0.6) !important;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.9; transform: scale(1.02); }
        }
        .action-cell {
            width: 120px;
            text-align: center;
        }
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background: linear-gradient(135deg, var(--white), #f8f9fa);
            margin: auto;
            padding: 35px;
            border: 3px solid var(--info-color);
            border-radius: 20px;
            width: 90%;
            max-width: 650px;
            box-shadow: 0 20px 60px var(--shadow-dark);
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .modal-content::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(52, 152, 219, 0.1) 0%, transparent 70%);
            animation: float 10s ease-in-out infinite;
        }
        .modal-content h2 {
            color: var(--primary-color);
            margin-bottom: 25px;
            font-size: 1.8em;
            font-weight: 700;
            position: relative;
            z-index: 1;
        }
        .modal-content input[type="text"] {
            width: calc(100% - 25px);
            padding: 15px;
            margin: 15px 0;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
        }
        .modal-content input[type="text"]:focus {
            outline: none;
            border-color: var(--info-color);
            box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.2);
        }
        .modal-content button {
            background: linear-gradient(135deg, var(--success-color), #2ecc71);
            color: var(--white);
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            margin: 8px;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
            position: relative;
            z-index: 1;
        }
        .modal-content button:hover {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(39, 174, 96, 0.4);
        }
        .modal-content .close-button {
            background: linear-gradient(135deg, var(--danger-color), #e74c3c);
            box-shadow: 0 5px 15px rgba(192, 57, 43, 0.3);
        }
        .modal-content .close-button:hover {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            box-shadow: 0 8px 25px rgba(192, 57, 43, 0.4);
        }
        /* History Section */
        .history-section {
            background: linear-gradient(135deg, #f8f9fa, #ffffff);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px var(--shadow);
            margin-top: 40px;
            border: 2px solid rgba(52, 73, 94, 0.1);
        }
        .history-section h3 {
            margin-top: 0;
            color: var(--primary-color);
            text-align: center;
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--accent-color);
        }
        #savedPlansList {
            list-style: none;
            padding: 0;
        }
        #savedPlansList li {
            background: linear-gradient(135deg, var(--white), #f8f9fa);
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 15px var(--shadow);
            flex-wrap: wrap;
            transition: all 0.3s ease;
        }
        #savedPlansList li:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px var(--shadow-dark);
            border-color: var(--info-color);
        }
        #savedPlansList li span {
            font-weight: 600;
            color: var(--primary-color);
            flex-grow: 1;
            margin-right: 15px;
            white-space: normal;
            font-size: 1.1em;
        }
        #savedPlansList li .history-actions button {
            padding: 10px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin-left: 10px;
            transition: all 0.3s ease;
        }
        #savedPlansList li .history-actions .load-btn {
            background: linear-gradient(135deg, var(--info-color), #2980b9);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }
        #savedPlansList li .history-actions .load-btn:hover {
            background: linear-gradient(135deg, #2980b9, #1f618d);
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(52, 152, 219, 0.4);
        }
        /* Category Manager Modal */
        #categoryManagerModal .modal-content {
            text-align: left;
            max-width: 800px;
        }
        #categoryManagerModal .add-category-btn {
            background: linear-gradient(135deg, var(--success-color), #2ecc71);
            padding: 12px 20px;
            border-radius: 20px;
            font-weight: 600;
        }
        #categoryManagerModal .category-list {
            margin-top: 25px;
            max-height: 400px; /* Added for scroll */
            overflow-y: auto; /* Added for scroll */
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9fa, var(--white));
        }
        #categoryManagerModal .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }
        #categoryManagerModal .category-item:hover {
            background: rgba(52, 152, 219, 0.1);
            border-radius: 8px;
            padding: 12px 8px;
        }
        #categoryManagerModal .category-item:last-child {
            border-bottom: none;
        }
        #categoryManagerModal .category-item span {
            font-weight: 600;
            flex-grow: 1;
            color: var(--primary-color);
        }
        #categoryManagerModal .category-actions .rename-btn {
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
            color: var(--white);
        }
        #categoryManagerModal .category-actions .delete-category-btn {
            background: linear-gradient(135deg, var(--danger-color), #e74c3c);
        }
        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            .content {
                padding: 20px;
            }
            .header {
                padding: 25px 20px;
            }
            .header h1 {
                font-size: 2.2em;
            }
            .action-buttons {
                flex-direction: column;
                align-items: center;
            }
            .action-buttons button {
                width: 100%;
                max-width: 300px;
            }
            .input-section {
                grid-template-columns: 1fr;
                padding: 20px;
            }
            .table-section {
                padding: 15px;
            }
            table {
                font-size: 0.9em;
            }
            th, td {
                padding: 10px 8px;
            }
            .budget-summary {
                padding: 25px;
            }
            .modal-content {
                width: 95%;
                padding: 25px;
            }
            #savedPlansList li {
                flex-direction: column;
                align-items: flex-start;
            }
            #savedPlansList li .history-actions {
                margin-top: 15px;
                width: 100%;
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
            }
            #savedPlansList li .history-actions button {
                margin-left: 0;
                flex: 1;
                min-width: 120px;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="gratarPlanContainer">
        <div class="header">
            <h1>üî• Calculator GrƒÉtar - Planificator Simplificat üî•</h1>
            <p>GestioneazƒÉ-»õi lista de grƒÉtar √Æn timp real »ôi salveazƒÉ-»õi planurile!</p>
            <div class="action-buttons">
                <button onclick="genereazaListaCumparaturiSiDescarca()">üõí GenereazƒÉ ListƒÉ CumpƒÉrƒÉturi</button>
                <button onclick="deschideModalSalvarePlan()">üíæ SalveazƒÉ Plan √Æn Istoric</button>
                <button onclick="deschideModalCategorii()">‚öôÔ∏è GestioneazƒÉ Categorii</button>
                <button onclick="resetPlanCurent()">üîÑ ReseteazƒÉ Plan</button>
                <button id="undoBtn" onclick="undo()" disabled>‚Ü© AnuleazƒÉ</button>
                <button id="redoBtn" onclick="redo()" disabled>‚Ü™ RefƒÉ</button>
            </div>
        </div>

        <div class="content">
            <div class="input-section">
                <div class="input-group">
                    <label for="persoane">NumƒÉrul de persoane:</label>
                    <input type="number" id="persoane" value="28" min="1" max="100">
                </div>
                <div class="input-group">
                    <label for="buget">Buget total (RON):</label>
                    <input type="number" id="buget" value="1200" min="0" step="0.01">
                </div>
            </div>

            <div class="tables-grid-container" id="tablesGridContainer">
                </div>

            <div class="budget-summary" id="budgetSummary">
                <h3>üìä Sumar Buget</h3>
                <div class="budget-row">
                    <span>Buget total:</span>
                    <span id="totalBuget">1200.00 RON</span>
                </div>
                <div class="budget-row">
                    <span>Total cheltuieli (est. necesar):</span>
                    <span id="totalCheltuieli">0.00 RON</span>
                </div>
                <div class="remaining-budget">
                    <div class="budget-row">
                        <span>Bani rƒÉma»ôi:</span>
                        <span id="baniRamasi">1200.00 RON</span>
                    </div>
                </div>
            </div>

            <div class="history-section">
                <h3>üìö Istoric Planuri Salvate</h3>
                <ul id="savedPlansList">
                </ul>
                <p id="noPlansMessage" style="text-align: center; color: var(--dark-gray);">Nu existƒÉ planuri salvate. SalveazƒÉ unul acum!</p>
            </div>
        </div>
    </div>

    <div id="savePlanModal" class="modal">
        <div class="modal-content">
            <h2>SalveazƒÉ Planul</h2>
            <p>Introdu un nume pentru acest plan:</p>
            <input type="text" id="planNameInput" placeholder="Numele planului (ex: GrƒÉtar Aniversar)">
            <button onclick="salveazaPlanInLocalStorage()">SalveazƒÉ</button>
            <button class="close-button" onclick="inchideModalSalvarePlan()">AnuleazƒÉ</button>
        </div>
    </div>

    <div id="categoryManagerModal" class="modal">
        <div class="modal-content">
            <h2>GestioneazƒÉ Categorii</h2>
            <div>
                <input type="text" id="newCategoryName" placeholder="Nume categorie nouƒÉ">
                <button class="add-category-btn" onclick="adaugaCategorieNoua()">AdaugƒÉ</button>
            </div>
            <div class="category-list">
                <ul id="existingCategoriesList">
                    </ul>
            </div>
            <div class="modal-buttons">
                <button class="close-button" onclick="inchideModalCategorii()">√énchide</button>
            </div>
        </div>
    </div>

    <script>
        // Starea implicitƒÉ a aplica»õiei (categorii »ôi produse)
        const DEFAULT_PRODUCTS_STATE = {
            carne: [
                { nume: "Mici", cantitate: 2, unitate: "kg", pret: 25, am_acasa: false, notite: "" },
                { nume: "CeafƒÉ de porc", cantitate: 1, unitate: "buc", pret: 50, am_acasa: false, notite: "BucatƒÉ de 1 kg" },
                { nume: "Pulpe dezosate de pui", cantitate: 1.5, unitate: "kg", pret: 16, am_acasa: false, notite: "" },
                { nume: "C√¢rna»õi de porc", cantitate: 1, unitate: "kg", pret: 18, am_acasa: false, notite: "" }
            ],
            legume: [
                { nume: "CeapƒÉ", cantitate: 0.5, unitate: "kg", pret: 4, am_acasa: false, notite: "" },
                { nume: "Ciuperci brune", cantitate: 1, unitate: "caserola", pret: 12, am_acasa: false, notite: "" },
                { nume: "LƒÉm√¢i", cantitate: 3, unitate: "buc", pret: 2, am_acasa: false, notite: "" },
                { nume: "Lime", cantitate: 2, unitate: "buc", pret: 3, am_acasa: false, notite: "" },
                { nume: "Portocale", cantitate: 1, unitate: "kg", pret: 6, am_acasa: false, notite: "" }
            ],
            bauturi: [
                { nume: "Bere", cantitate: 3, unitate: "bax", pret: 35, am_acasa: false, notite: "" },
                { nume: "Bere fƒÉrƒÉ alcool", cantitate: 6, unitate: "buc", pret: 4, am_acasa: false, notite: "" },
                { nume: "Cola", cantitate: 1, unitate: "bax", pret: 25, am_acasa: false, notite: "" },
                { nume: "ApƒÉ (5L)", cantitate: 2, unitate: "buc", pret: 8, am_acasa: false, notite: "" },
                { nume: "Rom", cantitate: 1, unitate: "sticla", pret: 35, am_acasa: false, notite: "" }
            ],
            condimente: [
                { nume: "P√¢ine", cantitate: 4, unitate: "buc", pret: 4, am_acasa: false, notite: "" },
                { nume: "Mu»ôtar", cantitate: 1, unitate: "borcan", pret: 6, am_acasa: false, notite: "" },
                { nume: "Chipsuri/Semin»õe", cantitate: 3, unitate: "buc", pret: 8, am_acasa: false, notite: "" },
                { nume: "Ghea»õƒÉ", cantitate: 2, unitate: "kg", pret: 5, am_acasa: false, notite: "" },
                { nume: "Carbuni", cantitate: 1, unitate: "sac", pret: 25, am_acasa: false, notite: "" },
                { nume: "Farfurii", cantitate: 1, unitate: "set", pret: 15, am_acasa: false, notite: "Set de 50 buc" },
                { nume: "Pahare", cantitate: 1, unitate: "set", pret: 12, am_acasa: false, notite: "" },
                { nume: "Role bucƒÉtƒÉrie", cantitate: 1, unitate: "buc", pret: 8, am_acasa: false, notite: "" },
                { nume: "Saci gunoi mari", cantitate: 1, unitate: "buc", pret: 12, am_acasa: false, notite: "" }
            ],
            diverse: [] // Categorie implicitƒÉ pentru produse mutate sau orfane
        };

        const DEFAULT_PERSONS = 28;
        const DEFAULT_BUDGET = 1200;
        const DEFAULT_CATEGORIES = ['carne', 'legume', 'bauturi', 'condimente', 'diverse'];

        // Variabile globale pentru starea curentƒÉ a aplica»õiei
        let produse = {};
        let currentPersons = DEFAULT_PERSONS;
        let currentBudget = DEFAULT_BUDGET;

        // Undo/Redo History
        let historyStack = [];
        let historyPointer = -1;
        const MAX_HISTORY_STEPS = 20; // LimitƒÉm numƒÉrul de pa»ôi pentru a nu consuma prea multƒÉ memorie

        // Sorting state
        let sortDirections = {}; // { 'categoryName': { 'columnName': 'asc' | 'desc' } }

        const LOCAL_STORAGE_KEY_PLAN = 'gratar_plan_curent';
        const LOCAL_STORAGE_KEY_HISTORY = 'gratar_planuri_salvate';

        // --- Func»õii Utilitare pentru Stocare LocalƒÉ »ôi Istoric ---

        function saveStateForHistory() {
            // EliminƒÉ stƒÉrile mai noi dacƒÉ am fƒÉcut undo »ôi acum facem o nouƒÉ modificare
            if (historyPointer < historyStack.length - 1) {
                historyStack = historyStack.slice(0, historyPointer + 1);
            }

            // AdaugƒÉ starea curentƒÉ √Æn istoric
            const currentState = {
                produse: JSON.parse(JSON.stringify(produse)),
                persoane: parseInt(document.getElementById('persoane').value) || 0,
                buget: parseFloat(document.getElementById('buget').value) || 0
            };
            historyStack.push(currentState);

            // Men»õine dimensiunea istoriei
            if (historyStack.length > MAX_HISTORY_STEPS) {
                historyStack.shift(); // EliminƒÉ cea mai veche stare
            } else {
                historyPointer++;
            }
            updateUndoRedoButtons();
        }

        function applyStateFromHistory(state) {
            produse = JSON.parse(JSON.stringify(state.produse));
            document.getElementById('persoane').value = state.persoane;
            document.getElementById('buget').value = state.buget;
            actualizeazaToate();
            saveCurrentPlanToLocalStorage(); // SalveazƒÉ starea curentƒÉ √Æn local storage
            updateUndoRedoButtons();
        }

        function undo() {
            if (historyPointer > 0) {
                historyPointer--;
                applyStateFromHistory(historyStack[historyPointer]);
            }
        }

        function redo() {
            if (historyPointer < historyStack.length - 1) {
                historyPointer++;
                applyStateFromHistory(historyStack[historyPointer]);
            }
        }

        function updateUndoRedoButtons() {
            document.getElementById('undoBtn').disabled = historyPointer <= 0;
            document.getElementById('redoBtn').disabled = historyPointer >= historyStack.length - 1;
        }

        function saveCurrentPlanToLocalStorage() {
            const planState = {
                produse: produse,
                persoane: parseInt(document.getElementById('persoane').value) || 0,
                buget: parseFloat(document.getElementById('buget').value) || 0
            };
            localStorage.setItem(LOCAL_STORAGE_KEY_PLAN, JSON.stringify(planState));
        }

        function loadCurrentPlanFromLocalStorage() {
            const savedPlan = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY_PLAN));
            if (savedPlan) {
                produse = savedPlan.produse;
                currentPersons = savedPlan.persoane;
                currentBudget = savedPlan.buget;
                document.getElementById('persoane').value = currentPersons;
                document.getElementById('buget').value = currentBudget;
            } else {
                // Initialize with default if no saved plan
                produse = JSON.parse(JSON.stringify(DEFAULT_PRODUCTS_STATE));
                currentPersons = DEFAULT_PERSONS;
                currentBudget = DEFAULT_BUDGET;
                saveCurrentPlanToLocalStorage(); // Save defaults for next load
            }

            // Ensure 'diverse' category exists if any products are left orphaned during old data loads
            if (!produse['diverse']) {
                produse['diverse'] = [];
            }
        }

        function resetPlanCurent() {
            if (confirm('E»ôti sigur cƒÉ vrei sƒÉ resetezi planul curent? Toate produsele »ôi setƒÉrile vor fi »ôterse!')) {
                produse = JSON.parse(JSON.stringify(DEFAULT_PRODUCTS_STATE));
                document.getElementById('persoane').value = DEFAULT_PERSONS;
                document.getElementById('buget').value = DEFAULT_BUDGET;
                saveCurrentPlanToLocalStorage();
                saveStateForHistory(); // SalveazƒÉ starea resetatƒÉ √Æn istoric
                actualizeazaToate();
                alert('Planul a fost resetat la valorile implicite.');
            }
        }

        // --- Func»õii pentru Drag-and-Drop ---
        let draggingRow = null;
        let originalCategory = null;

        function handleDragStart(event, category, index) {
            draggingRow = event.target.closest('tr');
            originalCategory = category;
            draggingRow.classList.add('dragging');
            event.dataTransfer.setData('text/plain', JSON.stringify({ category, index }));
            event.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';

            const target = event.target.closest('tr') || event.target.closest('tbody');

            // Remove drag-over from all elements first
            document.querySelectorAll('.drag-over, .drag-over-top').forEach(el => el.classList.remove('drag-over', 'drag-over-top'));

            if (target && draggingRow && target !== draggingRow) {
                if (target.tagName === 'TR') {
                    const rect = target.getBoundingClientRect();
                    const y = event.clientY - rect.top;
                    if (y < rect.height / 2) {
                        target.classList.add('drag-over-top'); // Add class for top border
                    } else {
                        target.classList.add('drag-over'); // Add class for bottom border
                    }
                } else if (target.tagName === 'TBODY' && target.children.length === 0) {
                    target.classList.add('drag-over'); // If tbody is empty, highlight the tbody itself
                }
            }
        }

        function handleDragLeave(event) {
            event.target.closest('tr')?.classList.remove('drag-over', 'drag-over-top');
            event.target.closest('tbody')?.classList.remove('drag-over');
        }

        function handleDrop(event) {
            event.preventDefault();
            document.querySelectorAll('.drag-over, .drag-over-top').forEach(el => el.classList.remove('drag-over', 'drag-over-top'));

            if (!draggingRow) return;

            const data = JSON.parse(event.dataTransfer.getData('text/plain'));
            const sourceCategory = data.category;
            const sourceIndex = data.index;

            const targetRowElement = event.target.closest('tr');
            const targetTbodyElement = event.target.closest('tbody');

            let targetCategory = null;
            let targetIndex = -1;

            if (targetRowElement) {
                targetCategory = targetRowElement.dataset.category;
                const rows = Array.from(targetTbodyElement.children);
                targetIndex = rows.indexOf(targetRowElement);

                const rect = targetRowElement.getBoundingClientRect();
                const y = event.clientY - rect.top;
                if (y >= rect.height / 2) { // If dropping below the target row, increment index
                    targetIndex += 1;
                }
            } else if (targetTbodyElement) {
                // Find the actual category name from the h3 element of the parent .table-section
                const h3TextElement = targetTbodyElement.closest('.table-section').querySelector('h3');
                targetCategory = h3TextElement.childNodes[0].textContent.trim().toLowerCase(); // Get text before button

                if (!produse[targetCategory]) {
                    produse[targetCategory] = [];
                }
                targetIndex = produse[targetCategory].length; // Drop at the end of the tbody
            }

            if (targetCategory === null || targetIndex === -1) {
                draggingRow.classList.remove('dragging');
                draggingRow = null;
                originalCategory = null;
                return;
            }

            if (sourceCategory === targetCategory) {
                const [movedProduct] = produse[sourceCategory].splice(sourceIndex, 1);
                produse[targetCategory].splice(targetIndex, 0, movedProduct);
            } else {
                const [movedProduct] = produse[sourceCategory].splice(sourceIndex, 1);
                // Make sure targetCategory exists, create if not
                if (!produse[targetCategory]) {
                    produse[targetCategory] = [];
                }
                produse[targetCategory].splice(targetIndex, 0, movedProduct);
            }

            draggingRow.classList.remove('dragging');
            draggingRow = null;
            originalCategory = null;

            actualizeazaToate();
            saveStateForHistory(); // SalveazƒÉ starea dupƒÉ drag-and-drop
        }

        function attachDragDropListeners() {
            const allRows = document.querySelectorAll('tr[draggable="true"]');
            allRows.forEach(row => {
                // Remove existing listeners to prevent duplicates
                ['dragstart', 'dragover', 'dragleave', 'drop', 'dragenter'].forEach(event => {
                    row.removeEventListener(event, row._dragEventHandler);
                });

                // Attach new listeners
                const category = row.dataset.category;
                const index = parseInt(row.dataset.index);

                row._dragEventHandler = (e) => { // Store handler for removal
                    if (e.type === 'dragstart') handleDragStart(e, category, index);
                    else if (e.type === 'dragover') handleDragOver(e);
                    else if (e.type === 'dragleave') handleDragLeave(e);
                    else if (e.type === 'drop') handleDrop(e);
                    else if (e.type === 'dragenter') e.preventDefault();
                };

                ['dragstart', 'dragover', 'dragleave', 'drop', 'dragenter'].forEach(event => {
                    row.addEventListener(event, row._dragEventHandler);
                });
            });

            const allTbodies = document.querySelectorAll('.table-section tbody');
            allTbodies.forEach(tbody => {
                // Remove existing listeners to prevent duplicates
                ['dragover', 'dragleave', 'drop', 'dragenter'].forEach(event => {
                    tbody.removeEventListener(event, tbody._dragEventHandler);
                });

                // Attach new listeners
                tbody._dragEventHandler = (e) => { // Store handler for removal
                    if (e.type === 'dragover') handleDragOver(e);
                    else if (e.type === 'dragleave') handleDragLeave(e);
                    else if (e.type === 'drop') handleDrop(e);
                    else if (e.type === 'dragenter') e.preventDefault();
                };

                ['dragover', 'dragleave', 'drop', 'dragenter'].forEach(event => {
                    tbody.addEventListener(event, tbody._dragEventHandler);
                });
            });
        }


        // --- Func»õii pentru CRUD Categorii ---
        function deschideModalCategorii() {
            document.getElementById('categoryManagerModal').style.display = 'flex';
            afiseazaCategoriiExistente();
        }

        function inchideModalCategorii() {
            document.getElementById('categoryManagerModal').style.display = 'none';
        }

        function afiseazaCategoriiExistente() {
            const listElement = document.getElementById('existingCategoriesList');
            listElement.innerHTML = '';
            const currentCategories = Object.keys(produse).sort();

            currentCategories.forEach(cat => {
                const li = document.createElement('li');
                li.className = 'category-item';

                const span = document.createElement('span');
                span.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
                li.appendChild(span);

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'category-actions';

                const renameInput = document.createElement('input');
                renameInput.type = 'text';
                renameInput.value = cat;
                renameInput.style.display = 'none';

                const renameBtn = document.createElement('button');
                renameBtn.textContent = 'Redenume»ôte';
                renameBtn.className = 'rename-btn';
                renameBtn.onclick = () => {
                    if (renameInput.style.display === 'none') {
                        span.style.display = 'none';
                        renameInput.style.display = 'inline-block';
                        renameInput.focus();
                    } else {
                        redenumesteCategorie(cat, renameInput.value);
                    }
                };

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = '»òterge';
                deleteBtn.className = 'delete-category-btn';
                deleteBtn.onclick = () => stergeCategorie(cat);

                actionsDiv.appendChild(renameInput);
                actionsDiv.appendChild(renameBtn);
                actionsDiv.appendChild(deleteBtn); // Show delete button for all categories

                li.appendChild(actionsDiv);
                listElement.appendChild(li);
            });
        }

        function adaugaCategorieNoua() {
            const newCategoryNameInput = document.getElementById('newCategoryName');
            let newCategoryName = newCategoryNameInput.value.trim();

            if (!newCategoryName) {
                alert('Numele categoriei nu poate fi gol!');
                return;
            }
            // NormalizeazƒÉ numele categoriei (fƒÉrƒÉ spa»õii, lowercase)
            newCategoryName = newCategoryName.toLowerCase().replace(/\s+/g, '-');

            if (produse[newCategoryName]) {
                alert('O categorie cu acest nume existƒÉ deja!');
                return;
            }

            produse[newCategoryName] = [];
            newCategoryNameInput.value = '';
            saveCurrentPlanToLocalStorage();
            saveStateForHistory(); // SalveazƒÉ starea dupƒÉ adƒÉugarea categoriei
            actualizeazaToate();
            afiseazaCategoriiExistente();
        }

        function redenumesteCategorie(oldName, newName) {
            newName = newName.trim();
            if (!newName) {
                alert('Numele categoriei nu poate fi gol!');
                afiseazaCategoriiExistente(); // Refresh the list
                return;
            }
            newName = newName.toLowerCase().replace(/\s+/g, '-');

            if (oldName === newName) {
                afiseazaCategoriiExistente(); // Refresh the list
                return;
            }
            if (produse[newName]) {
                alert('O categorie cu acest nume existƒÉ deja!');
                afiseazaCategoriiExistente(); // Refresh the list
                return;
            }

            produse[newName] = produse[oldName];
            delete produse[oldName];

            saveCurrentPlanToLocalStorage();
            saveStateForHistory(); // SalveazƒÉ starea dupƒÉ redenumire
            actualizeazaToate();
            afiseazaCategoriiExistente();
        }

        function stergeCategorie(categoryToDelete) {
            const defaultCategoriesSet = new Set(DEFAULT_CATEGORIES);

            if (produse[categoryToDelete] && produse[categoryToDelete].length > 0) {
                // Category has products
                if (defaultCategoriesSet.has(categoryToDelete)) {
                    // It's a default category with products
                    if (confirm(`Categoria "${categoryToDelete}" con»õine produse. Vrei sƒÉ le mu»õi √Æn categoria "diverse" »ôi apoi sƒÉ »ôtergi "${categoryToDelete}"?`)) {
                        const defaultDiverseCategory = 'diverse';
                        if (!produse[defaultDiverseCategory]) {
                            produse[defaultDiverseCategory] = [];
                        }
                        produse[defaultDiverseCategory].push(...produse[categoryToDelete]);
                        delete produse[categoryToDelete];
                    } else {
                        return; // User canceled
                    }
                } else {
                    // It's a custom category with products
                    if (confirm(`Categoria "${categoryToDelete}" con»õine produse. Vrei sƒÉ le mu»õi √Æn categoria "diverse" »ôi apoi sƒÉ »ôtergi "${categoryToDelete}"?`)) {
                        const defaultDiverseCategory = 'diverse';
                        if (!produse[defaultDiverseCategory]) {
                            produse[defaultDiverseCategory] = [];
                        }
                        produse[defaultDiverseCategory].push(...produse[categoryToDelete]);
                        delete produse[categoryToDelete];
                    } else {
                        return; // User canceled
                    }
                }
            } else {
                // Category is empty or doesn't exist (though the button implies it exists)
                if (confirm(`E»ôti sigur cƒÉ vrei sƒÉ »ôtergi categoria "${categoryToDelete}"?`)) {
                    delete produse[categoryToDelete];
                } else {
                    return; // User canceled
                }
            }

            saveCurrentPlanToLocalStorage();
            saveStateForHistory(); // SalveazƒÉ starea dupƒÉ »ôtergerea categoriei
            actualizeazaToate();
            afiseazaCategoriiExistente();
        }


        // --- Func»õii Modificate pentru a Suporta Categorii Dinamice »ôi Sortare ---
        function actualizeazaToate() {
            const tablesGridContainer = document.getElementById('tablesGridContainer');
            tablesGridContainer.innerHTML = '';

            const currentCategories = Object.keys(produse).sort();

            currentCategories.forEach(category => {
                const section = document.createElement('div');
                section.className = 'table-section';

                const categoryDisplayName = category.charAt(0).toUpperCase() + category.slice(1);

                section.innerHTML = `
                    <h3>${categoryDisplayName} <button class="add-btn" onclick="adaugaProdus('${category}')">+ AdaugƒÉ</button></h3>
                    <table id="${category}Table">
                        <thead>
                            <tr>
                                <th onclick="sorteazaTabel('${category}', 'nume')">Produs <span class="sort-indicator" id="${category}numeIndicator"></span></th>
                                <th onclick="sorteazaTabel('${category}', 'cantitate')">Cantitate <span class="sort-indicator" id="${category}cantitateIndicator"></span></th>
                                <th onclick="sorteazaTabel('${category}', 'unitate')">Unitate <span class="sort-indicator" id="${category}unitateIndicator"></span></th>
                                <th onclick="sorteazaTabel('${category}', 'pret')">Pre»õ/Unitate (RON) <span class="sort-indicator" id="${category}pretIndicator"></span></th>
                                <th>Am AcasƒÉ</th>
                                <th>Noti»õe</th>
                                <th>Total (RON)</th>
                                <th>Ac»õiuni</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                `;
                tablesGridContainer.appendChild(section);
                actualizeazaTabela(`${category}Table`, produse[category], category);
            });
            actualizeazaBuget();
            attachDragDropListeners();
        }

        function actualizeazaTabela(tabelId, produse_categorie, categoria) {
            const tabel = document.getElementById(tabelId);
            if (!tabel) return;
            const tbody = tabel.querySelector('tbody');
            if (!tbody) return;

            tbody.innerHTML = '';

            produse_categorie.forEach((produs, index) => {
                const totalProdusCalculat = (produs.cantitate * produs.pret).toFixed(2);

                const row = tbody.insertRow();
                row.setAttribute('draggable', true);
                row.dataset.category = categoria;
                row.dataset.index = index;

                row.innerHTML = `
                    <td><input type="text" class="editable-input" value="${produs.nume}" onchange="actualizeazaProprietate('${categoria}', ${index}, 'nume', this.value)"></td>
                    <td><input type="number" class="quantity-input" value="${produs.cantitate}" step="0.01" onchange="actualizeazaProprietate('${categoria}', ${index}, 'cantitate', parseFloat(this.value) || 0)"></td>
                    <td><input type="text" class="editable-input" value="${produs.unitate}" onchange="actualizeazaProprietate('${categoria}', ${index}, 'unitate', this.value)"></td>
                    <td><input type="number" class="price-input" value="${produs.pret}" step="0.01" onchange="actualizeazaProprietate('${categoria}', ${index}, 'pret', parseFloat(this.value) || 0)"></td>
                    <td><input type="checkbox" onchange="actualizeazaProprietate('${categoria}', ${index}, 'am_acasa', this.checked)" ${produs.am_acasa ? 'checked' : ''}></td>
                    <td><input type="text" class="notes-input" value="${produs.notite}" onchange="actualizeazaProprietate('${categoria}', ${index}, 'notite', this.value)"></td>
                    <td class="total-price">${totalProdusCalculat} RON</td>
                    <td class="action-cell"><button class="delete-btn" onclick="stergeProdus('${categoria}', ${index})">»òterge</button></td>
                `;
            });
            updateSortIndicators(categoria);
        }

        function actualizeazaProprietate(categoria, index, proprietate, valoareNoua) {
            if (!produse[categoria] || !produse[categoria][index]) {
                console.error("Produsul nu a putut fi gƒÉsit:", categoria, index);
                return;
            }
            produse[categoria][index][proprietate] = valoareNoua;
            actualizeazaToate();
            saveStateForHistory(); // SalveazƒÉ starea dupƒÉ modificare
        }

        function adaugaProdus(categoria) {
            const produs = {
                nume: "Produs nou",
                cantitate: 1,
                unitate: "buc",
                pret: 1,
                am_acasa: false,
                notite: ""
            };
            if (!produse[categoria]) {
                produse[categoria] = [];
            }
            produse[categoria].push(produs);
            actualizeazaToate();
            saveStateForHistory(); // SalveazƒÉ starea dupƒÉ adƒÉugare
        }

        function stergeProdus(categoria, index) {
            if (confirm('Sigur vrei sƒÉ »ôtergi acest produs?')) {
                produse[categoria].splice(index, 1);
                actualizeazaToate();
                saveStateForHistory(); // SalveazƒÉ starea dupƒÉ »ôtergere
            }
        }

        function calculeazaTotalCheltuieli() {
            let total = 0;
            Object.values(produse).forEach(categorieProduse => {
                categorieProduse.forEach(produs => {
                    if (!produs.am_acasa) {
                        total += produs.cantitate * produs.pret;
                    }
                });
            });
            return total;
        }

        function actualizeazaBuget() {
            const bugetTotal = parseFloat(document.getElementById('buget').value) || 0;
            const totalCheltuieli = calculeazaTotalCheltuieli();
            const baniRamasi = bugetTotal - totalCheltuieli;

            document.getElementById('totalBuget').textContent = `${bugetTotal.toFixed(2)} RON`;
            document.getElementById('totalCheltuieli').textContent = `${totalCheltuieli.toFixed(2)} RON`;
            document.getElementById('baniRamasi').textContent = `${baniRamasi.toFixed(2)} RON`;

            const budgetSummary = document.getElementById('budgetSummary');
            if (baniRamasi < 0) {
                budgetSummary.classList.add('warning');
            } else {
                budgetSummary.classList.remove('warning');
            }
            saveCurrentPlanToLocalStorage(); // SalveazƒÉ la actualizarea bugetului
            // Nu se adaugƒÉ √Æn historyStack aici, pentru a evita spam-ul la fiecare tastare.
            // Se adaugƒÉ la √ÆncƒÉrcare/resetare.
        }

        function sorteazaTabel(categoria, cheie) {
            if (!sortDirections[categoria]) {
                sortDirections[categoria] = {};
            }
            // Toggle sort direction
            sortDirections[categoria][cheie] = sortDirections[categoria][cheie] === 'asc' ? 'desc' : 'asc';

            produse[categoria].sort((a, b) => {
                let valA = a[cheie];
                let valB = b[cheie];

                // Handle numbers and strings appropriately
                if (typeof valA === 'string' && !isNaN(parseFloat(valA)) && isFinite(valA)) {
                    valA = parseFloat(valA);
                    valB = parseFloat(valB);
                }

                if (sortDirections[categoria][cheie] === 'asc') {
                    return valA > valB ? 1 : -1;
                } else {
                    return valA < valB ? 1 : -1;
                }
            });
            actualizeazaTabela(categoria + 'Table', produse[categoria], categoria);
            saveStateForHistory(); // SalveazƒÉ starea dupƒÉ sortare
        }

        function updateSortIndicators(category) {
            const headers = document.querySelectorAll(`#${category}Table th`);
            headers.forEach(header => {
                const columnName = header.textContent.split(' ')[0].toLowerCase(); // Simplified way to get column name
                const indicator = header.querySelector('.sort-indicator');
                if (indicator) {
                    indicator.textContent = ''; // Clear existing indicator

                    if (sortDirections[category] && sortDirections[category][columnName]) {
                        indicator.textContent = sortDirections[category][columnName] === 'asc' ? '‚ñ≤' : '‚ñº';
                    }
                }
            });
        }

        // Func»õia pentru generarea »ôi descƒÉrcarea listei de cumpƒÉrƒÉturi (TXT)
        function genereazaListaCumparaturiSiDescarca() {
            const nr_persoane = parseInt(document.getElementById('persoane').value) || 0;

            const lista = {};
            let totalLista = 0;
            let outputText = "--- Lista de CumpƒÉrƒÉturi GrƒÉtar ---\n\n";
            outputText += `NumƒÉr persoane estimate: ${nr_persoane}\n\n`;

            Object.values(produse).forEach(categorie => {
                categorie.forEach(produs => {
                    if (!produs.am_acasa) {
                        const cantitateNecesara = produs.cantitate;
                        const pretTotalProdus = cantitateNecesara * produs.pret;

                        if (lista[produs.nume]) {
                            lista[produs.nume].cantitate += cantitateNecesara;
                            lista[produs.nume].pretTotal += pretTotalProdus;
                        } else {
                            lista[produs.nume] = {
                                cantitate: cantitateNecesara,
                                unitate: produs.unitate,
                                pretTotal: pretTotalProdus,
                                notite: produs.notite
                            };
                        }
                        totalLista += pretTotalProdus;
                    }
                });
            });

            for (const numeProdus in lista) {
                const item = lista[numeProdus];
                outputText += `- ${numeProdus}: ${item.cantitate.toFixed(2)} ${item.unitate} (${item.pretTotal.toFixed(2)} RON)\n`;
                if (item.notite) {
                    outputText += `  (Noti»õe: ${item.notite})\n`;
                }
            }

            outputText += `\n--------------------------------------\n`;
            outputText += `Total estimat pentru cumpƒÉrƒÉturi: ${totalLista.toFixed(2)} RON\n`;
            outputText += `--------------------------------------\n`;

            const blob = new Blob([outputText], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const date = new Date();
            const filename = `lista_cumparaturi_gratar_${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}.txt`;
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('Lista de cumpƒÉrƒÉturi a fost generatƒÉ »ôi descƒÉrcatƒÉ!');
        }

        // Functii pentru Istoric Planuri
        function deschideModalSalvarePlan() {
            document.getElementById('savePlanModal').style.display = 'flex';
            document.getElementById('planNameInput').value = '';
            document.getElementById('planNameInput').focus();
        }

        function inchideModalSalvarePlan() {
            document.getElementById('savePlanModal').style.display = 'none';
        }

        function salveazaPlanInLocalStorage() {
            const planName = document.getElementById('planNameInput').value.trim();
            if (!planName) {
                alert('Te rog introdu un nume pentru plan!');
                return;
            }

            const savedPlans = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY_HISTORY) || '[]');
            const timestamp = new Date().toISOString();

            const currentPlanState = {
                name: planName,
                date: new Date().toLocaleString('ro-RO'),
                timestamp: timestamp,
                persoane: parseInt(document.getElementById('persoane').value) || 0,
                buget: parseFloat(document.getElementById('buget').value) || 0,
                produse: JSON.parse(JSON.stringify(produse))
            };

            savedPlans.push(currentPlanState);
            localStorage.setItem(LOCAL_STORAGE_KEY_HISTORY, JSON.stringify(savedPlans));
            inchideModalSalvarePlan();
            afiseazaPlanuriSalvate();
            saveStateForHistory(); // SalveazƒÉ starea dupƒÉ salvarea planului √Æn istoric
            alert(`Planul "${planName}" a fost salvat!`);
        }

        function afiseazaPlanuriSalvate() {
            const savedPlans = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY_HISTORY) || '[]');
            const listElement = document.getElementById('savedPlansList');
            const noPlansMessage = document.getElementById('noPlansMessage');
            listElement.innerHTML = '';

            if (savedPlans.length === 0) {
                noPlansMessage.style.display = 'block';
                return;
            } else {
                noPlansMessage.style.display = 'none';
            }

            savedPlans.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            savedPlans.forEach((plan, index) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${plan.name} <br> <small>${plan.date}</small></span>
                    <div class="history-actions">
                        <button class="load-btn" onclick="incarcaPlan('${plan.timestamp}')">√éncarcƒÉ</button>
                        <button class="delete-btn" onclick="stergePlan('${plan.timestamp}')">»òterge</button>
                    </div>
                `;
                listElement.appendChild(li);
            });
        }

        function incarcaPlan(timestamp) {
            const savedPlans = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY_HISTORY) || '[]');
            const planToLoad = savedPlans.find(p => p.timestamp === timestamp);

            if (planToLoad && confirm(`Sigur vrei sƒÉ √Æncarci planul "${planToLoad.name}"? ModificƒÉrile curente nesalvate se vor pierde.`)) {
                // Set the global variables first
                currentPersons = planToLoad.persoane;
                currentBudget = planToLoad.buget;

                // Update input fields
                document.getElementById('persoane').value = currentPersons;
                document.getElementById('buget').value = currentBudget;

                // Apply the products state
                produse = JSON.parse(JSON.stringify(planToLoad.produse));

                // Then re-render and save the new current state
                actualizeazaToate();
                saveStateForHistory(); // SalveazƒÉ starea √ÆncƒÉrcatƒÉ √Æn istoric
                alert(`Planul "${planToLoad.name}" a fost √ÆncƒÉrcat!`);
            }
        }

        function stergePlan(timestamp) {
            if (confirm('Sigur vrei sƒÉ »ôtergi acest plan din istoric?')) {
                let savedPlans = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY_HISTORY) || '[]');
                savedPlans = savedPlans.filter(p => p.timestamp !== timestamp);
                localStorage.setItem(LOCAL_STORAGE_KEY_HISTORY, JSON.stringify(savedPlans));
                afiseazaPlanuriSalvate();
                alert('Plan »ôters din istoric.');
            }
        }

        // Ini»õializare la √ÆncƒÉrcarea paginii
        document.addEventListener('DOMContentLoaded', () => {
            loadCurrentPlanFromLocalStorage(); // √éncƒÉrcƒÉm starea curentƒÉ (inclusiv produse »ôi categorii)
            saveStateForHistory(); // SalveazƒÉ starea ini»õialƒÉ √Æn istoric
            actualizeazaToate(); // Afi»ôeazƒÉ toate tabelele cu datele √ÆncƒÉrcate
            afiseazaPlanuriSalvate(); // Afi»ôeazƒÉ istoricul planurilor

            // Atach events for budget and persons inputs
            document.getElementById('persoane').addEventListener('input', actualizeazaBuget);
            document.getElementById('buget').addEventListener('input', actualizeazaBuget);
        });
    </script>
</body>
</html>
