<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculator GrƒÉtar - Planificator Simplificat</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); /* Gri √Ænchis la negru */
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            color: #ecf0f1; /* Text deschis pentru fundal √Ænchis */
        }

        .container {
            max-width: 1400px; /* LƒÉ»õime mai mare pentru mai mult spa»õiu */
            margin: 0 auto;
            background: #f8f9fa; /* Fundal deschis pentru con»õinut */
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            overflow: hidden;
            color: #333; /* Text √Ænchis pentru con»õinut deschis */
        }

        .header {
            background: linear-gradient(135deg, #34495e, #2c3e50); /* Gradient gri √Ænchis */
            color: white;
            padding: 30px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .header h1 {
            margin: 0;
            font-size: 2.5em;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            margin-top: 10px;
            font-size: 1.1em;
            color: #bdc3c7;
        }

        .action-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap; /* Permite butoanelor sƒÉ se a»ôeze pe r√¢ndul urmƒÉtor */
        }

        .action-buttons button {
            background: #555;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .action-buttons button:hover {
            background: #777;
            transform: translateY(-2px);
        }

        .content {
            padding: 30px;
        }

        .input-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: #eceff1; /* Gri foarte deschis */
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }

        .input-group input {
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
            background: white;
            color: #333;
        }

        .input-group input:focus {
            outline: none;
            border-color: #6a82fb; /* O nuan»õƒÉ de albastru/violet */
            box-shadow: 0 0 0 3px rgba(106, 130, 251, 0.2);
        }

        .tables-grid-container {
            display: grid;
            grid-template-columns: 1fr; /* Doar o singurƒÉ coloanƒÉ */
            gap: 30px; /* Spa»õiu √Æntre sec»õiunile de tabel */
            margin-bottom: 30px;
        }

        .table-section {
            background: #eceff1; /* Gri foarte deschis */
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        .table-section h3 {
            margin-top: 0;
            color: #333;
            text-align: center;
            font-size: 1.3em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #cfd8dc; /* Linie sub titlu */
        }

        .add-btn {
            background: #28a745; /* Verde */
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease, transform 0.2s ease;
        }

        .add-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .delete-btn {
            background: #dc3545; /* Ro»ôu */
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s ease, transform 0.2s ease;
        }

        .delete-btn:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
            color: #333;
            white-space: nowrap; /* Previne ruperea textului √Æn coloane */
        }

        th {
            background: #555; /* Gri √Ænchis pentru antet */
            color: white;
            font-weight: bold;
            cursor: pointer; /* Pentru sortare */
        }

        th:hover {
            background: #666;
        }

        tr:hover {
            background: #f5f5f5;
        }

        .editable-input,
        .price-input,
        .quantity-input,
        .notes-input {
            width: calc(100% - 8px);
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
            color: #333;
        }

        .editable-input:focus,
        .price-input:focus,
        .quantity-input:focus,
        .notes-input:focus {
            outline: none;
            border-color: #6a82fb;
            box-shadow: 0 0 0 2px rgba(106, 130, 251, 0.2);
        }

        .price-input, .quantity-input {
            text-align: center;
        }

        .total-price {
            font-weight: bold;
            color: #27ae60;
        }

        .quantity {
            font-weight: bold;
            color: #e74c3c;
        }

        .budget-summary {
            background: linear-gradient(135deg, #34495e, #2c3e50); /* Gradient gri √Ænchis */
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .budget-summary h3 {
            margin: 0 0 15px 0;
            font-size: 1.5em;
            color: #ecf0f1;
        }

        .budget-row {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 1.1em;
            color: #bdc3c7;
        }

        .remaining-budget {
            font-size: 1.3em;
            font-weight: bold;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid rgba(255,255,255,0.2);
            color: white;
        }

        .warning {
            background: #c0392b !important; /* Ro»ôu mai √Ænchis */
            animation: pulse 2s infinite;
            box-shadow: 0 0 15px rgba(192, 57, 43, 0.5) !important;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }

        .action-cell {
            width: 100px; /* LƒÉ»õime ajustatƒÉ */
            text-align: center;
        }

        /* Stiluri pentru modal (pop-up) */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            border-radius: 10px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
        }

        .modal-content input[type="text"] {
            width: calc(100% - 20px);
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
        }

        .modal-content button {
            background: #5cb85c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 1em;
            transition: background 0.3s ease;
        }

        .modal-content button:hover {
            background: #4cae4c;
        }

        .modal-content .close-button {
            background: #f44336;
        }
        .modal-content .close-button:hover {
            background: #da190b;
        }

        /* Stiluri pentru Istoric Planuri Salvate */
        .history-section {
            background: #eceff1;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            margin-top: 30px;
        }

        .history-section h3 {
            margin-top: 0;
            color: #333;
            text-align: center;
            font-size: 1.3em;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #cfd8dc;
        }

        #savedPlansList {
            list-style: none;
            padding: 0;
        }

        #savedPlansList li {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            flex-wrap: wrap; /* Permite elementelor sƒÉ se a»ôeze pe r√¢ndul urmƒÉtor pe ecrane mici */
        }

        #savedPlansList li span {
            font-weight: bold;
            color: #333;
            flex-grow: 1; /* Permite numelui sƒÉ ocupe spa»õiu */
            margin-right: 10px;
            white-space: normal; /* Permite textului sƒÉ se √Æncadreze */
        }

        #savedPlansList li .history-actions button {
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.9em;
            margin-left: 8px;
        }

        #savedPlansList li .history-actions .load-btn {
            background: #007bff;
        }
        #savedPlansList li .history-actions .load-btn:hover {
            background: #0056b3;
        }

        #savedPlansList li .history-actions .download-csv-btn {
            background: #ffc107; /* Galben */
            color: #333;
        }
        #savedPlansList li .history-actions .download-csv-btn:hover {
            background: #e0a800;
        }

        #savedPlansList li .history-actions .delete-btn {
            background: #dc3545;
        }
        #savedPlansList li .history-actions .delete-btn:hover {
            background: #c82333;
        }
    </style>
</head>
<body>
    <div class="container" id="gratarPlanContainer">
        <div class="header">
            <h1>üî• Calculator GrƒÉtar - Planificator Simplificat üî•</h1>
            <p>GestioneazƒÉ-»õi lista de grƒÉtar √Æn timp real »ôi salveazƒÉ-»õi planurile!</p>
            <div class="action-buttons">
                <button onclick="salveazaPlanCaImagine()">üì∏ SalveazƒÉ Plan (Imagine)</button>
                <button onclick="genereazaListaCumparaturiSiDescarca()">üõí GenereazƒÉ ListƒÉ CumpƒÉrƒÉturi</button>
                <button onclick="exportaPlanCurentCSV()">üìä ExportƒÉ Plan Curent (CSV)</button>
                <button onclick="deschideModalSalvarePlan()">üíæ SalveazƒÉ Plan √Æn Istoric</button>
            </div>
        </div>

        <div class="content">
            <div class="input-section">
                <div class="input-group">
                    <label for="persoane">NumƒÉrul de persoane:</label>
                    <input type="number" id="persoane" value="28" min="1" max="100">
                </div>
                <div class="input-group">
                    <label for="buget">Buget total (RON):</label>
                    <input type="number" id="buget" value="1200" min="0" step="0.01">
                </div>
            </div>

            <div class="tables-grid-container">
                <div class="table-section">
                    <h3>ü•© Carne »ôi Preparate <button class="add-btn" onclick="adaugaProdus('carne')">+ AdaugƒÉ</button></h3>
                    <table id="carneTable">
                        <thead>
                            <tr>
                                <th onclick="sorteazaTabel('carne', 'nume')">Produs</th>
                                <th onclick="sorteazaTabel('carne', 'cantitate')">Cantitate</th>
                                <th onclick="sorteazaTabel('carne', 'unitate')">Unitate</th>
                                <th onclick="sorteazaTabel('carne', 'pret')">Pre»õ/Unitate (RON)</th>
                                <th>Am AcasƒÉ</th>
                                <th>Noti»õe</th>
                                <th>Total (RON)</th>
                                <th>Ac»õiuni</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="table-section">
                    <h3>ü•ó Legume »ôi Fructe <button class="add-btn" onclick="adaugaProdus('legume')">+ AdaugƒÉ</button></h3>
                    <table id="legumeTable">
                        <thead>
                            <tr>
                                <th onclick="sorteazaTabel('legume', 'nume')">Produs</th>
                                <th onclick="sorteazaTabel('legume', 'cantitate')">Cantitate</th>
                                <th onclick="sorteazaTabel('legume', 'unitate')">Unitate</th>
                                <th onclick="sorteazaTabel('legume', 'pret')">Pre»õ/Unitate (RON)</th>
                                <th>Am AcasƒÉ</th>
                                <th>Noti»õe</th>
                                <th>Total (RON)</th>
                                <th>Ac»õiuni</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="table-section">
                    <h3>üç∫ BƒÉuturi »ôi Alcool <button class="add-btn" onclick="adaugaProdus('bauturi')">+ AdaugƒÉ</button></h3>
                    <table id="bauturiTable">
                        <thead>
                            <tr>
                                <th onclick="sorteazaTabel('bauturi', 'nume')">Produs</th>
                                <th onclick="sorteazaTabel('bauturi', 'cantitate')">Cantitate</th>
                                <th onclick="sorteazaTabel('bauturi', 'unitate')">Unitate</th>
                                <th onclick="sorteazaTabel('bauturi', 'pret')">Pre»õ/Unitate (RON)</th>
                                <th>Am AcasƒÉ</th>
                                <th>Noti»õe</th>
                                <th>Total (RON)</th>
                                <th>Ac»õiuni</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="table-section">
                    <h3>üçΩÔ∏è Accesorii »ôi Diverse <button class="add-btn" onclick="adaugaProdus('condimente')">+ AdaugƒÉ</button></h3>
                    <table id="condimenteTable">
                        <thead>
                            <tr>
                                <th onclick="sorteazaTabel('condimente', 'nume')">Produs</th>
                                <th onclick="sorteazaTabel('condimente', 'cantitate')">Cantitate</th>
                                <th onclick="sorteazaTabel('condimente', 'unitate')">Unitate</th>
                                <th onclick="sorteazaTabel('condimente', 'pret')">Pre»õ/Unitate (RON)</th>
                                <th>Am AcasƒÉ</th>
                                <th>Noti»õe</th>
                                <th>Total (RON)</th>
                                <th>Ac»õiuni</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="budget-summary" id="budgetSummary">
                <h3>üìä Sumar Buget</h3>
                <div class="budget-row">
                    <span>Buget total:</span>
                    <span id="totalBuget">1200.00 RON</span>
                </div>
                <div class="budget-row">
                    <span>Total cheltuieli (est. necesar):</span>
                    <span id="totalCheltuieli">0.00 RON</span>
                </div>
                <div class="remaining-budget">
                    <div class="budget-row">
                        <span>Bani rƒÉma»ôi:</span>
                        <span id="baniRamasi">1200.00 RON</span>
                    </div>
                </div>
            </div>

            <div class="history-section">
                <h3>üìö Istoric Planuri Salvate</h3>
                <ul id="savedPlansList">
                    </ul>
                <p id="noPlansMessage" style="text-align: center; color: #666;">Nu existƒÉ planuri salvate. SalveazƒÉ unul acum!</p>
            </div>
        </div>
    </div>

    <div id="savePlanModal" class="modal">
        <div class="modal-content">
            <h2>SalveazƒÉ Planul</h2>
            <p>Introdu un nume pentru acest plan:</p>
            <input type="text" id="planNameInput" placeholder="Numele planului (ex: GrƒÉtar Aniversar)">
            <button onclick="salveazaPlanInLocalStorage()">SalveazƒÉ</button>
            <button class="close-button" onclick="inchideModalSalvarePlan()">AnuleazƒÉ</button>
        </div>
    </div>

    <script>
        let produse = {
            carne: [
                { nume: "Mici", cantitate: 2, unitate: "kg", pret: 25, am_acasa: false, notite: "" },
                { nume: "CeafƒÉ de porc", cantitate: 1, unitate: "buc", pret: 50, am_acasa: false, notite: "BucatƒÉ de 1 kg" },
                { nume: "Pulpe dezosate de pui", cantitate: 1.5, unitate: "kg", pret: 16, am_acasa: false, notite: "" },
                { nume: "C√¢rna»õi de porc", cantitate: 1, unitate: "kg", pret: 18, am_acasa: false, notite: "" }
            ],
            legume: [
                { nume: "CeapƒÉ", cantitate: 0.5, unitate: "kg", pret: 4, am_acasa: false, notite: "" },
                { nume: "Ciuperci brune", cantitate: 1, unitate: "caserola", pret: 12, am_acasa: false, notite: "" },
                { nume: "LƒÉm√¢i", cantitate: 3, unitate: "buc", pret: 2, am_acasa: false, notite: "" },
                { nume: "Lime", cantitate: 2, unitate: "buc", pret: 3, am_acasa: false, notite: "" },
                { nume: "Portocale", cantitate: 1, unitate: "kg", pret: 6, am_acasa: false, notite: "" }
            ],
            bauturi: [
                { nume: "Bere", cantitate: 3, unitate: "bax", pret: 35, am_acasa: false, notite: "" },
                { nume: "Bere fƒÉrƒÉ alcool", cantitate: 6, unitate: "buc", pret: 4, am_acasa: false, notite: "" },
                { nume: "Cola", cantitate: 1, unitate: "bax", pret: 25, am_acasa: false, notite: "" },
                { nume: "ApƒÉ (5L)", cantitate: 2, unitate: "buc", pret: 8, am_acasa: false, notite: "" },
                { nume: "Rom", cantitate: 1, unitate: "sticla", pret: 35, am_acasa: false, notite: "" }
            ],
            condimente: [
                { nume: "P√¢ine", cantitate: 4, unitate: "buc", pret: 4, am_acasa: false, notite: "" },
                { nume: "Mu»ôtar", cantitate: 1, unitate: "borcan", pret: 6, am_acasa: false, notite: "" },
                { nume: "Chipsuri/Semin»õe", cantitate: 3, unitate: "buc", pret: 8, am_acasa: false, notite: "" },
                { nume: "Ghea»õƒÉ", cantitate: 2, unitate: "kg", pret: 5, am_acasa: false, notite: "" },
                { nume: "Carbuni", cantitate: 1, unitate: "sac", pret: 25, am_acasa: false, notite: "" },
                { nume: "Farfurii", cantitate: 1, unitate: "set", pret: 15, am_acasa: false, notite: "Set de 50 buc" },
                { nume: "Pahare", cantitate: 1, unitate: "set", pret: 12, am_acasa: false, notite: "Set de 50 buc" },
                { nume: "Role bucƒÉtƒÉrie", cantitate: 1, unitate: "buc", pret: 8, am_acasa: false, notite: "" },
                { nume: "Saci gunoi mari", cantitate: 1, unitate: "buc", pret: 12, am_acasa: false, notite: "" }
            ]
        };

        // Cantitatea este acum numƒÉrul de unitƒÉ»õi (ex: saci, bucƒÉ»õi, kg) direct
        function calculeazaTotalProdus(cantitate, pret) {
            return (cantitate * pret).toFixed(2);
        }

        function actualizeazaTabela(tabelId, produse_categorie, categoria) {
            const tabel = document.getElementById(tabelId);
            const tbody = tabel.querySelector('tbody');

            tbody.innerHTML = '';

            produse_categorie.forEach((produs, index) => {
                const totalProdusCalculat = calculeazaTotalProdus(produs.cantitate, produs.pret);

                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><input type="text" class="editable-input" value="${produs.nume}" onchange="actualizeazaProprietate('${categoria}', ${index}, 'nume', this.value)"></td>
                    <td><input type="number" class="quantity-input" value="${produs.cantitate}" step="0.01" onchange="actualizeazaProprietate('${categoria}', ${index}, 'cantitate', parseFloat(this.value) || 0)"></td>
                    <td><input type="text" class="editable-input" value="${produs.unitate}" onchange="actualizeazaProprietate('${categoria}', ${index}, 'unitate', this.value)"></td>
                    <td><input type="number" class="price-input" value="${produs.pret}" step="0.01" onchange="actualizeazaProprietate('${categoria}', ${index}, 'pret', parseFloat(this.value) || 0)"></td>
                    <td><input type="checkbox" onchange="actualizeazaProprietate('${categoria}', ${index}, 'am_acasa', this.checked)" ${produs.am_acasa ? 'checked' : ''}></td>
                    <td><input type="text" class="notes-input" value="${produs.notite}" onchange="actualizeazaProprietate('${categoria}', ${index}, 'notite', this.value)"></td>
                    <td class="total-price">${totalProdusCalculat} RON</td>
                    <td class="action-cell"><button class="delete-btn" onclick="stergeProdus('${categoria}', ${index})">»òterge</button></td>
                `;
            });
        }

        function actualizeazaProprietate(categoria, index, proprietate, valoareNoua) {
            produse[categoria][index][proprietate] = valoareNoua;
            actualizeazaToate();
        }

        function adaugaProdus(categoria) {
            const produs = {
                nume: "Produs nou",
                cantitate: 1, // Cantitatea ini»õialƒÉ este 1 unitate
                unitate: "buc",
                pret: 1,
                am_acasa: false,
                notite: ""
            };
            produse[categoria].push(produs);
            actualizeazaToate();
        }

        function stergeProdus(categoria, index) {
            if (confirm('Sigur vrei sƒÉ »ôtergi acest produs?')) {
                produse[categoria].splice(index, 1);
                actualizeazaToate();
            }
        }

        function calculeazaTotalCheltuieli() {
            let total = 0;

            Object.values(produse).forEach(categorie => {
                categorie.forEach(produs => {
                    if (!produs.am_acasa) { // Include doar produsele care nu sunt "acasƒÉ"
                        total += produs.cantitate * produs.pret;
                    }
                });
            });
            return total;
        }

        function actualizeazaBuget() {
            const bugetTotal = parseFloat(document.getElementById('buget').value) || 0;
            const totalCheltuieli = calculeazaTotalCheltuieli();
            const baniRamasi = bugetTotal - totalCheltuieli;

            document.getElementById('totalBuget').textContent = `${bugetTotal.toFixed(2)} RON`;
            document.getElementById('totalCheltuieli').textContent = `${totalCheltuieli.toFixed(2)} RON`;
            document.getElementById('baniRamasi').textContent = `${baniRamasi.toFixed(2)} RON`;

            const budgetSummary = document.getElementById('budgetSummary');
            if (baniRamasi < 0) {
                budgetSummary.classList.add('warning');
            } else {
                budgetSummary.classList.remove('warning');
            }
        }

        function actualizeazaToate() {
            actualizeazaTabela('carneTable', produse.carne, 'carne');
            actualizeazaTabela('legumeTable', produse.legume, 'legume');
            actualizeazaTabela('bauturiTable', produse.bauturi, 'bauturi');
            actualizeazaTabela('condimenteTable', produse.condimente, 'condimente');
            actualizeazaBuget();
            // Nu mai actualizƒÉm istoricul aici, ci doar la salvare/»ôtergere
        }

        function sorteazaTabel(categoria, cheie) {
            produse[categoria].sort((a, b) => {
                if (typeof a[cheie] === 'string') {
                    return a[cheie].localeCompare(b[cheie]);
                }
                return a[cheie] - b[cheie];
            });
            actualizeazaTabela(categoria + 'Table', produse[categoria], categoria);
        }

        // Func»õia pentru salvarea planului ca imagine
        function salveazaPlanCaImagine() {
            const element = document.getElementById('gratarPlanContainer');

            const options = {
                scale: 2, // MƒÉre»ôte rezolu»õia pentru o calitate mai bunƒÉ a imaginii
                useCORS: true,
                logging: false,
                backgroundColor: '#f8f9fa'
            };

            html2canvas(element, options).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const a = document.createElement('a');
                const date = new Date();
                const filename = `plan_gratar_${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}_${date.getHours().toString().padStart(2, '0')}${date.getMinutes().toString().padStart(2, '0')}.png`;
                a.href = imgData;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                alert('Planul a fost salvat ca imagine!');
            }).catch(error => {
                console.error('Eroare la salvarea imaginii:', error);
                alert('A apƒÉrut o eroare la salvarea planului ca imagine. Te rog sƒÉ √Æncerci din nou.');
            });
        }

        // Func»õia pentru generarea »ôi descƒÉrcarea listei de cumpƒÉrƒÉturi (TXT)
        function genereazaListaCumparaturiSiDescarca() {
            const nr_persoane = parseInt(document.getElementById('persoane').value) || 0;

            const lista = {};
            let totalLista = 0;
            let outputText = "--- Lista de CumpƒÉrƒÉturi GrƒÉtar ---\n\n";
            outputText += `NumƒÉr persoane estimate: ${nr_persoane}\n\n`;

            Object.values(produse).forEach(categorie => {
                categorie.forEach(produs => {
                    if (!produs.am_acasa) {
                        const cantitateNecesara = produs.cantitate;
                        const pretTotalProdus = cantitateNecesara * produs.pret;

                        if (lista[produs.nume]) {
                            lista[produs.nume].cantitate += cantitateNecesara;
                            lista[produs.nume].pretTotal += pretTotalProdus;
                        } else {
                            lista[produs.nume] = {
                                cantitate: cantitateNecesara,
                                unitate: produs.unitate,
                                pretTotal: pretTotalProdus,
                                notite: produs.notite
                            };
                        }
                        totalLista += pretTotalProdus;
                    }
                });
            });

            for (const numeProdus in lista) {
                const item = lista[numeProdus];
                outputText += `- ${numeProdus}: ${item.cantitate.toFixed(2)} ${item.unitate} (${item.pretTotal.toFixed(2)} RON)\n`;
                if (item.notite) {
                    outputText += `  (Noti»õe: ${item.notite})\n`;
                }
            }

            outputText += `\n--------------------------------------\n`;
            outputText += `Total estimat pentru cumpƒÉrƒÉturi: ${totalLista.toFixed(2)} RON\n`;
            outputText += `--------------------------------------\n`;

            const blob = new Blob([outputText], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const date = new Date();
            const filename = `lista_cumparaturi_gratar_${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}.txt`;
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Functii pentru Istoric Planuri si CSV
        const LOCAL_STORAGE_KEY = 'gratar_planuri_salvate';

        function deschideModalSalvarePlan() {
            document.getElementById('savePlanModal').style.display = 'flex';
            document.getElementById('planNameInput').value = ''; // Gole»ôte inputul
            document.getElementById('planNameInput').focus(); // Pune focus pe input
        }

        function inchideModalSalvarePlan() {
            document.getElementById('savePlanModal').style.display = 'none';
        }

        function salveazaPlanInLocalStorage() {
            const planName = document.getElementById('planNameInput').value.trim();
            if (!planName) {
                alert('Te rog introdu un nume pentru plan!');
                return;
            }

            const savedPlans = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
            const timestamp = new Date().toISOString();

            const currentPlanState = {
                name: planName,
                date: new Date().toLocaleString('ro-RO'),
                timestamp: timestamp,
                persoane: parseInt(document.getElementById('persoane').value) || 0,
                buget: parseFloat(document.getElementById('buget').value) || 0,
                produse: JSON.parse(JSON.stringify(produse)) // ClonƒÉm obiectul produse
            };

            savedPlans.push(currentPlanState);
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(savedPlans));
            inchideModalSalvarePlan();
            afiseazaPlanuriSalvate();
            alert(`Planul "${planName}" a fost salvat!`);
        }

        function afiseazaPlanuriSalvate() {
            const savedPlans = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
            const listElement = document.getElementById('savedPlansList');
            const noPlansMessage = document.getElementById('noPlansMessage');
            listElement.innerHTML = '';

            if (savedPlans.length === 0) {
                noPlansMessage.style.display = 'block';
                return;
            } else {
                noPlansMessage.style.display = 'none';
            }

            savedPlans.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); // SorteazƒÉ de la cel mai nou la cel mai vechi

            savedPlans.forEach((plan, index) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${plan.name} <br> <small>${plan.date}</small></span>
                    <div class="history-actions">
                        <button class="load-btn" onclick="incarcaPlan('${plan.timestamp}')">√éncarcƒÉ</button>
                        <button class="download-csv-btn" onclick="exportaPlanCSV('${plan.timestamp}')">DescƒÉrcare CSV</button>
                        <button class="delete-btn" onclick="stergePlan('${plan.timestamp}')">»òterge</button>
                    </div>
                `;
                listElement.appendChild(li);
            });
        }

        function incarcaPlan(timestamp) {
            const savedPlans = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
            const planToLoad = savedPlans.find(p => p.timestamp === timestamp);

            if (planToLoad && confirm(`Sigur vrei sƒÉ √Æncarci planul "${planToLoad.name}"? ModificƒÉrile curente nesalvate se vor pierde.`)) {
                document.getElementById('persoane').value = planToLoad.persoane;
                document.getElementById('buget').value = planToLoad.buget;
                produse = JSON.parse(JSON.stringify(planToLoad.produse)); // Re√ÆncarcƒÉ produsele
                actualizeazaToate();
                alert(`Planul "${planToLoad.name}" a fost √ÆncƒÉrcat!`);
            }
        }

        function stergePlan(timestamp) {
            if (confirm('Sigur vrei sƒÉ »ôtergi acest plan din istoric?')) {
                let savedPlans = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
                savedPlans = savedPlans.filter(p => p.timestamp !== timestamp);
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(savedPlans));
                afiseazaPlanuriSalvate();
                alert('Plan »ôters din istoric.');
            }
        }

        // Func»õia care genereazƒÉ con»õinutul CSV
        function generateCSVContent(planData) {
            let csvContent = "";

            // Antetul CSV
            const headers = ["Categorie", "Produs", "Cantitate", "Unitate", "Pret/Unitate (RON)", "Am Acasa", "Notite", "Total (RON)"];
            csvContent += headers.join(",") + "\n"; // Folosim virgula ca separator

            // AdaugƒÉ datele pentru fiecare categorie
            for (const category in planData.produse) {
                planData.produse[category].forEach(produs => {
                    const totalProdus = (produs.cantitate * produs.pret).toFixed(2);
                    const row = [
                        category,
                        `"${produs.nume.replace(/"/g, '""')}"`, // √énlocuie»ôte ghilimelele duble cu douƒÉ ghilimele duble pentru a le escapa
                        produs.cantitate,
                        produs.unitate,
                        produs.pret,
                        produs.am_acasa ? "Da" : "Nu",
                        `"${produs.notite.replace(/"/g, '""')}"`,
                        totalProdus
                    ];
                    csvContent += row.join(",") + "\n";
                });
            }

            // AdaugƒÉ sumarul bugetului la final (op»õional, dar util)
            csvContent += "\n\n";
            csvContent += "Sumar Buget\n";
            csvContent += `Numar persoane:,${planData.persoane}\n`;
            csvContent += `Buget total:,${planData.buget.toFixed(2)} RON\n`;
            const totalCheltuieli = Object.values(planData.produse).flat().reduce((sum, p) => sum + (p.am_acasa ? 0 : p.cantitate * p.pret), 0);
            csvContent += `Total cheltuieli (est. necesar):,${totalCheltuieli.toFixed(2)} RON\n`;
            csvContent += `Bani ramasi:,${(planData.buget - totalCheltuieli).toFixed(2)} RON\n`;

            return csvContent;
        }

        // Func»õia pentru exportul planului curent √Æn CSV
        function exportaPlanCurentCSV() {
            const currentPlanState = {
                name: "Plan Curent", // Nume generic pentru exportul curent
                date: new Date().toLocaleString('ro-RO'),
                persoane: parseInt(document.getElementById('persoane').value) || 0,
                buget: parseFloat(document.getElementById('buget').value) || 0,
                produse: JSON.parse(JSON.stringify(produse))
            };
            const csv = generateCSVContent(currentPlanState);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const date = new Date();
            const filename = `plan_gratar_curent_${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}.csv`;
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('Planul curent a fost exportat √Æn CSV!');
        }

        // Func»õia pentru exportul unui plan din istoric √Æn CSV
        function exportaPlanCSV(timestamp) {
            const savedPlans = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
            const planToExport = savedPlans.find(p => p.timestamp === timestamp);

            if (planToExport) {
                const csv = generateCSVContent(planToExport);
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const filename = `plan_gratar_${planToExport.name.replace(/[^a-z0-9]/gi, '_')}_${new Date(planToExport.timestamp).toLocaleDateString('ro-RO').replace(/\./g, '-')}.csv`;
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                alert(`Planul "${planToExport.name}" a fost exportat √Æn CSV!`);
            } else {
                alert('Eroare: Planul nu a fost gƒÉsit √Æn istoric.');
            }
        }


        // Event listeners
        document.getElementById('persoane').addEventListener('input', actualizeazaBuget);
        document.getElementById('buget').addEventListener('input', actualizeazaBuget);

        // Ini»õializare
        actualizeazaToate();
        afiseazaPlanuriSalvate(); // Afi»ôeazƒÉ planurile salvate la √ÆncƒÉrcarea paginii
    </script>
</body>
</html>
