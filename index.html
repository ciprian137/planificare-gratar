<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculator Grătar - Planificator Simplificat</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            color: #ecf0f1;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #f8f9fa;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            overflow: hidden;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            padding: 30px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .header h1 {
            margin: 0;
            font-size: 2.5em;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            margin-top: 10px;
            font-size: 1.1em;
            color: #bdc3c7;
        }

        .action-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .action-buttons button {
            background: #555;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .action-buttons button:hover {
            background: #777;
            transform: translateY(-2px);
        }

        .content {
            padding: 30px;
        }

        .input-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: #eceff1;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }

        .input-group input {
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
            background: white;
            color: #333;
        }

        .input-group input:focus {
            outline: none;
            border-color: #6a82fb;
            box-shadow: 0 0 0 3px rgba(106, 130, 251, 0.2);
        }

        .tables-grid-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .table-section {
            background: #eceff1;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        .table-section h3 {
            margin-top: 0;
            color: #333;
            text-align: center;
            font-size: 1.3em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #cfd8dc;
        }

        .add-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease, transform 0.2s ease;
        }

        .add-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s ease, transform 0.2s ease;
        }

        .delete-btn:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
            color: #333;
            white-space: nowrap;
        }

        th {
            background: #555;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }

        th:hover {
            background: #666;
        }

        /* Stil pentru drag-and-drop */
        td {
            cursor: grab; /* Indica ca elementul este dragabil */
        }
        td:active {
            cursor: grabbing;
        }
        tr.dragging {
            opacity: 0.5;
            background-color: #e0f2f7; /* Fundal temporar cand se trage */
        }
        .drag-over {
            border-bottom: 2px solid #6a82fb; /* Indica unde va fi plasat elementul */
        }


        tr:hover {
            background: #f5f5f5;
        }

        .editable-input,
        .price-input,
        .quantity-input,
        .notes-input {
            width: calc(100% - 8px);
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
            color: #333;
        }

        .editable-input:focus,
        .price-input:focus,
        .quantity-input:focus,
        .notes-input:focus {
            outline: none;
            border-color: #6a82fb;
            box-shadow: 0 0 0 2px rgba(106, 130, 251, 0.2);
        }

        .price-input, .quantity-input {
            text-align: center;
        }

        .total-price {
            font-weight: bold;
            color: #27ae60;
        }

        .quantity {
            font-weight: bold;
            color: #e74c3c;
        }

        .budget-summary {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .budget-summary h3 {
            margin: 0 0 15px 0;
            font-size: 1.5em;
            color: #ecf0f1;
        }

        .budget-row {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 1.1em;
            color: #bdc3c7;
        }

        .remaining-budget {
            font-size: 1.3em;
            font-weight: bold;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid rgba(255,255,255,0.2);
            color: white;
        }

        .warning {
            background: #c0392b !important;
            animation: pulse 2s infinite;
            box-shadow: 0 0 15px rgba(192, 57, 43, 0.5) !important;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }

        .action-cell {
            width: 100px;
            text-align: center;
        }

        /* Stiluri pentru modal (pop-up) */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            border-radius: 10px;
            width: 80%;
            max-width: 600px; /* Lățime mai mare pentru modalul de categorii */
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
        }

        .modal-content input[type="text"] {
            width: calc(100% - 20px);
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
        }

        .modal-content button {
            background: #5cb85c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 1em;
            transition: background 0.3s ease;
        }

        .modal-content button:hover {
            background: #4cae4c;
        }

        .modal-content .close-button {
            background: #f44336;
        }
        .modal-content .close-button:hover {
            background: #da190b;
        }

        /* Stiluri pentru Istoric Planuri Salvate */
        .history-section {
            background: #eceff1;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            margin-top: 30px;
        }

        .history-section h3 {
            margin-top: 0;
            color: #333;
            text-align: center;
            font-size: 1.3em;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #cfd8dc;
        }

        #savedPlansList {
            list-style: none;
            padding: 0;
        }

        #savedPlansList li {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            flex-wrap: wrap;
        }

        #savedPlansList li span {
            font-weight: bold;
            color: #333;
            flex-grow: 1;
            margin-right: 10px;
            white-space: normal;
        }

        #savedPlansList li .history-actions button {
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.9em;
            margin-left: 8px;
        }

        #savedPlansList li .history-actions .load-btn {
            background: #007bff;
        }
        #savedPlansList li .history-actions .load-btn:hover {
            background: #0056b3;
        }

        #savedPlansList li .history-actions .download-csv-btn {
            background: #ffc107;
            color: #333;
        }
        #savedPlansList li .history-actions .download-csv-btn:hover {
            background: #e0a800;
        }

        #savedPlansList li .history-actions .delete-btn {
            background: #dc3545;
        }
        #savedPlansList li .history-actions .delete-btn:hover {
            background: #c82333;
        }

        /* Stiluri pentru modalul de categorii */
        #categoryManagerModal .modal-content {
            text-align: left;
        }
        #categoryManagerModal h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }
        #categoryManagerModal #newCategoryName {
            width: calc(100% - 130px);
            margin-right: 10px;
            display: inline-block;
        }
        #categoryManagerModal .add-category-btn {
            background: #28a745;
            padding: 10px 15px;
        }
        #categoryManagerModal .category-list {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 5px;
            padding: 10px;
            background: #f9f9f9;
        }
        #categoryManagerModal .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        #categoryManagerModal .category-item:last-child {
            border-bottom: none;
        }
        #categoryManagerModal .category-item span {
            font-weight: normal;
            flex-grow: 1;
        }
        #categoryManagerModal .category-item input[type="text"] {
            flex-grow: 1;
            margin-right: 10px;
            border: 1px solid #ccc;
            padding: 5px;
        }
        #categoryManagerModal .category-actions button {
            padding: 5px 10px;
            font-size: 0.8em;
            margin-left: 5px;
        }
        #categoryManagerModal .category-actions .rename-btn {
            background: #ffc107;
            color: #333;
        }
        #categoryManagerModal .category-actions .delete-category-btn {
            background: #dc3545;
        }
        #categoryManagerModal .modal-buttons {
            margin-top: 20px;
            text-align: right;
        }
    </style>
</head>
<body>
    <div class="container" id="gratarPlanContainer">
        <div class="header">
            <h1>🔥 Calculator Grătar - Planificator Simplificat 🔥</h1>
            <p>Gestionează-ți lista de grătar în timp real și salvează-ți planurile!</p>
            <div class="action-buttons">
                <button onclick="salveazaPlanCaImagine()">📸 Salvează Plan (Imagine)</button>
                <button onclick="genereazaListaCumparaturiSiDescarca()">🛒 Generează Listă Cumpărături</button>
                <button onclick="exportaPlanCurentCSV()">📊 Exportă Plan Curent (CSV)</button>
                <button onclick="deschideModalSalvarePlan()">💾 Salvează Plan în Istoric</button>
                <button onclick="deschideModalCategorii()">⚙️ Gestionează Categorii</button>
            </div>
        </div>

        <div class="content">
            <div class="input-section">
                <div class="input-group">
                    <label for="persoane">Numărul de persoane:</label>
                    <input type="number" id="persoane" value="28" min="1" max="100">
                </div>
                <div class="input-group">
                    <label for="buget">Buget total (RON):</label>
                    <input type="number" id="buget" value="1200" min="0" step="0.01">
                </div>
            </div>

            <div class="tables-grid-container" id="tablesGridContainer">
                </div>

            <div class="budget-summary" id="budgetSummary">
                <h3>📊 Sumar Buget</h3>
                <div class="budget-row">
                    <span>Buget total:</span>
                    <span id="totalBuget">1200.00 RON</span>
                </div>
                <div class="budget-row">
                    <span>Total cheltuieli (est. necesar):</span>
                    <span id="totalCheltuieli">0.00 RON</span>
                </div>
                <div class="remaining-budget">
                    <div class="budget-row">
                        <span>Bani rămași:</span>
                        <span id="baniRamasi">1200.00 RON</span>
                    </div>
                </div>
            </div>

            <div class="history-section">
                <h3>📚 Istoric Planuri Salvate</h3>
                <ul id="savedPlansList">
                </ul>
                <p id="noPlansMessage" style="text-align: center; color: #666;">Nu există planuri salvate. Salvează unul acum!</p>
            </div>
        </div>
    </div>

    <div id="savePlanModal" class="modal">
        <div class="modal-content">
            <h2>Salvează Planul</h2>
            <p>Introdu un nume pentru acest plan:</p>
            <input type="text" id="planNameInput" placeholder="Numele planului (ex: Grătar Aniversar)">
            <button onclick="salveazaPlanInLocalStorage()">Salvează</button>
            <button class="close-button" onclick="inchideModalSalvarePlan()">Anulează</button>
        </div>
    </div>

    <div id="categoryManagerModal" class="modal">
        <div class="modal-content">
            <h2>Gestionează Categorii</h2>
            <div>
                <input type="text" id="newCategoryName" placeholder="Nume categorie nouă">
                <button class="add-category-btn" onclick="adaugaCategorieNoua()">Adaugă</button>
            </div>
            <div class="category-list">
                <ul id="existingCategoriesList">
                    </ul>
            </div>
            <div class="modal-buttons">
                <button class="close-button" onclick="inchideModalCategorii()">Închide</button>
            </div>
        </div>
    </div>

    <script>
        let produse = {
            carne: [
                { nume: "Mici", cantitate: 2, unitate: "kg", pret: 25, am_acasa: false, notite: "" },
                { nume: "Ceafă de porc", cantitate: 1, unitate: "buc", pret: 50, am_acasa: false, notite: "Bucată de 1 kg" },
                { nume: "Pulpe dezosate de pui", cantitate: 1.5, unitate: "kg", pret: 16, am_acasa: false, notite: "" },
                { nume: "Cârnați de porc", cantitate: 1, unitate: "kg", pret: 18, am_acasa: false, notite: "" }
            ],
            legume: [
                { nume: "Ceapă", cantitate: 0.5, unitate: "kg", pret: 4, am_acasa: false, notite: "" },
                { nume: "Ciuperci brune", cantitate: 1, unitate: "caserola", pret: 12, am_acasa: false, notite: "" },
                { nume: "Lămâi", cantitate: 3, unitate: "buc", pret: 2, am_acasa: false, notite: "" },
                { nume: "Lime", cantitate: 2, unitate: "buc", pret: 3, am_acasa: false, notite: "" },
                { nume: "Portocale", cantitate: 1, unitate: "kg", pret: 6, am_acasa: false, notite: "" }
            ],
            bauturi: [
                { nume: "Bere", cantitate: 3, unitate: "bax", pret: 35, am_acasa: false, notite: "" },
                { nume: "Bere fără alcool", cantitate: 6, unitate: "buc", pret: 4, am_acasa: false, notite: "" },
                { nume: "Cola", cantitate: 1, unitate: "bax", pret: 25, am_acasa: false, notite: "" },
                { nume: "Apă (5L)", cantitate: 2, unitate: "buc", pret: 8, am_acasa: false, notite: "" },
                { nume: "Rom", cantitate: 1, unitate: "sticla", pret: 35, am_acasa: false, notite: "" }
            ],
            condimente: [
                { nume: "Pâine", cantitate: 4, unitate: "buc", pret: 4, am_acasa: false, notite: "" },
                { nume: "Muștar", cantitate: 1, unitate: "borcan", pret: 6, am_acasa: false, notite: "" },
                { nume: "Chipsuri/Semințe", cantitate: 3, unitate: "buc", pret: 8, am_acasa: false, notite: "" },
                { nume: "Gheață", cantitate: 2, unitate: "kg", pret: 5, am_acasa: false, notite: "" },
                { nume: "Carbuni", cantitate: 1, unitate: "sac", pret: 25, am_acasa: false, notite: "" },
                { nume: "Farfurii", cantitate: 1, unitate: "set", pret: 15, am_acasa: false, notite: "Set de 50 buc" },
                { nume: "Pahare", cantitate: 1, unitate: "set", pret: 12, am_acasa: false, notite: "" },
                { nume: "Role bucătărie", cantitate: 1, unitate: "buc", pret: 8, am_acasa: false, notite: "" },
                { nume: "Saci gunoi mari", cantitate: 1, unitate: "buc", pret: 12, am_acasa: false, notite: "" }
            ]
        };

        const CATEGORIES_KEY = 'gratar_categorii';
        const PRODUCTS_KEY = 'gratar_produse'; // Noua cheie pentru a salva obiectul produse

        // --- Funcții Utilitare pentru Stocare Locală ---
        function saveCategoriesToLocalStorage() {
            localStorage.setItem(CATEGORIES_KEY, JSON.stringify(Object.keys(produse)));
        }

        function loadCategoriesFromLocalStorage() {
            const savedCategories = JSON.parse(localStorage.getItem(CATEGORIES_KEY));
            if (savedCategories) {
                const newProduse = {};
                savedCategories.forEach(cat => {
                    newProduse[cat] = produse[cat] || []; // Păstrează produsele existente sau creează o listă goală
                });
                // Mută produsele din categoriile vechi care nu mai există în cele noi
                for (const oldCat in produse) {
                    if (!savedCategories.includes(oldCat)) {
                        const defaultCategory = 'diverse';
                        if (!newProduse[defaultCategory]) {
                            newProduse[defaultCategory] = [];
                        }
                        newProduse[defaultCategory].push(...produse[oldCat]);
                    }
                }
                produse = newProduse;
            }
            // Asigură-te că există întotdeauna cel puțin categoriile inițiale dacă nu sunt salvate altele
            if (Object.keys(produse).length === 0) {
                 produse = {
                    carne: [], legume: [], bauturi: [], condimente: []
                 };
            }
            saveProductsToLocalStorage(); // Salvează starea produselor după încărcarea categoriilor
        }

        function saveProductsToLocalStorage() {
            localStorage.setItem(PRODUCTS_KEY, JSON.stringify(produse));
        }

        function loadProductsFromLocalStorage() {
            const savedProducts = JSON.parse(localStorage.getItem(PRODUCTS_KEY));
            if (savedProducts) {
                produse = savedProducts;
            }
        }

        // --- Funcții pentru Drag-and-Drop ---
        let draggingRow = null;
        let originalTableId = null;

        function handleDragStart(event, category, index) {
            draggingRow = event.target.closest('tr');
            originalTableId = category + 'Table';
            draggingRow.classList.add('dragging');
            event.dataTransfer.setData('text/plain', JSON.stringify({ category, index }));
            event.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            const targetRow = event.target.closest('tr');
            if (targetRow && draggingRow && targetRow !== draggingRow) {
                // Adaugă o clasă pentru a indica vizual zona de drop
                const tbody = targetRow.parentNode;
                const rows = Array.from(tbody.children);
                const draggingIndex = rows.indexOf(draggingRow);
                const targetIndex = rows.indexOf(targetRow);

                rows.forEach(row => row.classList.remove('drag-over')); // Curăță vechile indicatoare
                if (targetIndex > draggingIndex) {
                    targetRow.classList.add('drag-over'); // Sub rând
                } else {
                    targetRow.previousElementSibling?.classList.add('drag-over'); // Deasupra rândului
                }
            }
        }

        function handleDragLeave(event) {
            const targetRow = event.target.closest('tr');
            if (targetRow) {
                targetRow.classList.remove('drag-over');
            }
        }

        function handleDrop(event, targetCategory, targetIndex) {
            event.preventDefault();
            const data = JSON.parse(event.dataTransfer.getData('text/plain'));
            const sourceCategory = data.category;
            const sourceIndex = data.index;

            const targetRowElement = event.target.closest('tr');
            if (targetRowElement) {
                targetRowElement.classList.remove('drag-over');
            }


            if (sourceCategory === targetCategory) {
                // Mutare în aceeași categorie
                const [movedProduct] = produse[sourceCategory].splice(sourceIndex, 1);
                produse[targetCategory].splice(targetIndex, 0, movedProduct);
            } else {
                // Mutare între categorii (nu este cerută explicit, dar o gestionăm ca posibilitate)
                const [movedProduct] = produse[sourceCategory].splice(sourceIndex, 1);
                produse[targetCategory].splice(targetIndex, 0, movedProduct);
                // Nu uita să cureți eventualele categorii goale dacă produsele au fost mutate
                if (produse[sourceCategory].length === 0 && sourceCategory !== 'diverse') {
                    // Poți alege să nu ștergi categoria goală, sau să o ștergi din produse și din lista de categorii salvate
                    // În acest exemplu, o lasăm și se va reconstrui la refresh dacă e goală, sau poți decide să o ștergi.
                }
            }

            draggingRow.classList.remove('dragging');
            draggingRow = null;
            originalTableId = null;

            actualizeazaToate(); // Reface toate tabelele pentru a reflecta noua ordine
            saveProductsToLocalStorage(); // Salvează noua ordine
        }

        // --- Funcții pentru CRUD Categorii ---
        function deschideModalCategorii() {
            document.getElementById('categoryManagerModal').style.display = 'flex';
            afiseazaCategoriiExistente();
        }

        function inchideModalCategorii() {
            document.getElementById('categoryManagerModal').style.display = 'none';
        }

        function afiseazaCategoriiExistente() {
            const listElement = document.getElementById('existingCategoriesList');
            listElement.innerHTML = '';
            const currentCategories = Object.keys(produse);

            currentCategories.forEach(cat => {
                const li = document.createElement('li');
                li.className = 'category-item';
                
                const span = document.createElement('span');
                span.textContent = cat.charAt(0).toUpperCase() + cat.slice(1); // capitalizează prima literă
                li.appendChild(span);

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'category-actions';

                const renameInput = document.createElement('input');
                renameInput.type = 'text';
                renameInput.value = cat;
                renameInput.style.display = 'none'; // Hidden by default

                const renameBtn = document.createElement('button');
                renameBtn.textContent = 'Redenumește';
                renameBtn.className = 'rename-btn';
                renameBtn.onclick = () => {
                    if (renameInput.style.display === 'none') {
                        span.style.display = 'none';
                        renameInput.style.display = 'inline-block';
                        renameInput.focus();
                    } else {
                        redenumesteCategorie(cat, renameInput.value);
                    }
                };

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Șterge';
                deleteBtn.className = 'delete-category-btn';
                deleteBtn.onclick = () => stergeCategorie(cat);

                actionsDiv.appendChild(renameInput);
                actionsDiv.appendChild(renameBtn);
                // Nu permitem ștergerea categoriilor goale implicite pentru a evita probleme la prima încărcare
                if (!['carne', 'legume', 'bauturi', 'condimente'].includes(cat) || produse[cat].length === 0) {
                     actionsDiv.appendChild(deleteBtn);
                }


                li.appendChild(actionsDiv);
                listElement.appendChild(li);
            });
        }

        function adaugaCategorieNoua() {
            const newCategoryNameInput = document.getElementById('newCategoryName');
            let newCategoryName = newCategoryNameInput.value.trim().toLowerCase();

            if (!newCategoryName) {
                alert('Numele categoriei nu poate fi gol!');
                return;
            }
            if (newCategoryName.includes(' ')) {
                newCategoryName = newCategoryName.replace(/\s+/g, '-'); // înlocuiește spațiile cu cratime
                alert(`Numele categoriei a fost ajustat la "${newCategoryName}" (fără spații).`);
            }
            if (produse[newCategoryName]) {
                alert('Această categorie există deja!');
                return;
            }

            produse[newCategoryName] = [];
            newCategoryNameInput.value = '';
            saveCategoriesToLocalStorage();
            saveProductsToLocalStorage(); // Update products structure
            actualizeazaToate();
            afiseazaCategoriiExistente(); // Refresh modal list
        }

        function redenumesteCategorie(oldName, newName) {
            newName = newName.trim().toLowerCase();
            if (!newName) {
                alert('Numele categoriei nu poate fi gol!');
                afiseazaCategoriiExistente(); // Refresh pentru a anula inputul gol
                return;
            }
            if (newName.includes(' ')) {
                newName = newName.replace(/\s+/g, '-');
            }
            if (oldName === newName) { // Nu s-a schimbat nimic
                afiseazaCategoriiExistente();
                return;
            }
            if (produse[newName]) {
                alert('O categorie cu acest nume există deja!');
                afiseazaCategoriiExistente(); // Refresh pentru a anula inputul invalid
                return;
            }

            produse[newName] = produse[oldName];
            delete produse[oldName];

            saveCategoriesToLocalStorage();
            saveProductsToLocalStorage();
            actualizeazaToate();
            afiseazaCategoriiExistente();
        }

        function stergeCategorie(categoryToDelete) {
            if (!confirm(`Sigur vrei să ștergi categoria "${categoryToDelete}"? Produsele din această categorie vor fi mutate în "diverse".`)) {
                return;
            }

            // Creează categoria "diverse" dacă nu există
            const defaultCategory = 'diverse';
            if (!produse[defaultCategory]) {
                produse[defaultCategory] = [];
            }

            // Mută produsele din categoria ștearsă în "diverse"
            if (produse[categoryToDelete]) {
                produse[defaultCategory].push(...produse[categoryToDelete]);
                delete produse[categoryToDelete];
            }

            saveCategoriesToLocalStorage();
            saveProductsToLocalStorage();
            actualizeazaToate();
            afiseazaCategoriiExistente();
        }

        // --- Funcții Modificate pentru a Suporta Categorii Dinamice ---
        function actualizeazaToate() {
            const tablesGridContainer = document.getElementById('tablesGridContainer');
            tablesGridContainer.innerHTML = ''; // Golește containerul de tabele

            const currentCategories = Object.keys(produse);

            currentCategories.forEach(category => {
                const section = document.createElement('div');
                section.className = 'table-section';
                
                const categoryDisplayName = category.charAt(0).toUpperCase() + category.slice(1); // Prima litera mare

                section.innerHTML = `
                    <h3>${categoryDisplayName} <button class="add-btn" onclick="adaugaProdus('${category}')">+ Adaugă</button></h3>
                    <table id="${category}Table">
                        <thead>
                            <tr>
                                <th onclick="sorteazaTabel('${category}', 'nume')">Produs</th>
                                <th onclick="sorteazaTabel('${category}', 'cantitate')">Cantitate</th>
                                <th onclick="sorteazaTabel('${category}', 'unitate')">Unitate</th>
                                <th onclick="sorteazaTabel('${category}', 'pret')">Preț/Unitate (RON)</th>
                                <th>Am Acasă</th>
                                <th>Notițe</th>
                                <th>Total (RON)</th>
                                <th>Acțiuni</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                `;
                tablesGridContainer.appendChild(section);
                actualizeazaTabela(`${category}Table`, produse[category], category);
            });
            actualizeazaBuget();
            // Re-atașează evenimentele de drag-and-drop după ce tabelele sunt regenerate
            attachDragDropListeners();
        }

        function actualizeazaTabela(tabelId, produse_categorie, categoria) {
            const tabel = document.getElementById(tabelId);
            if (!tabel) return; // Asigură-te că tabelul există
            const tbody = tabel.querySelector('tbody');
            if (!tbody) return; // Asigură-te că tbody există

            tbody.innerHTML = '';

            produse_categorie.forEach((produs, index) => {
                const totalProdusCalculat = calculeazaTotalProdus(produs.cantitate, produs.pret);

                const row = tbody.insertRow();
                row.setAttribute('draggable', true); // Face rândul dragabil
                row.dataset.category = categoria;
                row.dataset.index = index;
                row.addEventListener('dragstart', (e) => handleDragStart(e, categoria, index));
                row.addEventListener('dragover', handleDragOver);
                row.addEventListener('dragleave', handleDragLeave);
                row.addEventListener('drop', (e) => handleDrop(e, categoria, index)); // Drop pe rând
                row.addEventListener('dragenter', (e) => e.preventDefault()); // Necesar pentru drop

                row.innerHTML = `
                    <td><input type="text" class="editable-input" value="${produs.nume}" onchange="actualizeazaProprietate('${categoria}', ${index}, 'nume', this.value)"></td>
                    <td><input type="number" class="quantity-input" value="${produs.cantitate}" step="0.01" onchange="actualizeazaProprietate('${categoria}', ${index}, 'cantitate', parseFloat(this.value) || 0)"></td>
                    <td><input type="text" class="editable-input" value="${produs.unitate}" onchange="actualizeazaProprietate('${categoria}', ${index}, 'unitate', this.value)"></td>
                    <td><input type="number" class="price-input" value="${produs.pret}" step="0.01" onchange="actualizeazaProprietate('${categoria}', ${index}, 'pret', parseFloat(this.value) || 0)"></td>
                    <td><input type="checkbox" onchange="actualizeazaProprietate('${categoria}', ${index}, 'am_acasa', this.checked)" ${produs.am_acasa ? 'checked' : ''}></td>
                    <td><input type="text" class="notes-input" value="${produs.notite}" onchange="actualizeazaProprietate('${categoria}', ${index}, 'notite', this.value)"></td>
                    <td class="total-price">${totalProdusCalculat} RON</td>
                    <td class="action-cell"><button class="delete-btn" onclick="stergeProdus('${categoria}', ${index})">Șterge</button></td>
                `;
            });
        }

        // Re-atașează evenimentele de drag-drop la nivel de tbody pentru a prinde drop-uri când tabelul este gol sau la final
        function attachDragDropListeners() {
            const allTbodies = document.querySelectorAll('.table-section tbody');
            allTbodies.forEach(tbody => {
                const category = tbody.closest('.table-section').querySelector('h3').textContent.split(' ')[0].toLowerCase(); // Extrage categoria din titlu

                tbody.addEventListener('dragover', (event) => {
                    event.preventDefault();
                    event.dataTransfer.dropEffect = 'move';
                    // Adaugă clasa drag-over pe tbody dacă este gol
                    if (tbody.children.length === 0) {
                        tbody.classList.add('drag-over');
                    } else {
                        // Dacă nu e gol, handleDragOver pe rânduri deja se ocupă de asta
                        tbody.classList.remove('drag-over');
                    }
                });

                tbody.addEventListener('dragleave', (event) => {
                    tbody.classList.remove('drag-over');
                });

                tbody.addEventListener('drop', (event) => {
                    event.preventDefault();
                    tbody.classList.remove('drag-over'); // Curăță clasa vizuală

                    const data = JSON.parse(event.dataTransfer.getData('text/plain'));
                    const sourceCategory = data.category;
                    const sourceIndex = data.index;

                    // Daca drop-ul se face pe un tbody gol, adauga la finalul categoriei
                    if (tbody.children.length === 0) {
                        if (sourceCategory !== category) {
                            const [movedProduct] = produse[sourceCategory].splice(sourceIndex, 1);
                            produse[category].push(movedProduct); // Adaugă la categoria nouă, goală
                        }
                        // Dacă e aceeași categorie și e singurul element, nu facem nimic, e deja unde trebuie
                    } else {
                        // Drop pe un rând existent, deja gestionat de handleDrop pe rând
                        return;
                    }

                    if (draggingRow) {
                        draggingRow.classList.remove('dragging');
                        draggingRow = null;
                        originalTableId = null;
                    }

                    actualizeazaToate();
                    saveProductsToLocalStorage();
                });
            });
        }


        // Inițializare la încărcarea paginii
        document.addEventListener('DOMContentLoaded', () => {
            loadCategoriesFromLocalStorage(); // Încărcăm categoriile definite de utilizator
            loadProductsFromLocalStorage(); // Încărcăm produsele cu noua structură

            // Dacă nu există produse salvate, inițializează cu cele implicite
            if (Object.keys(produse).every(cat => produse[cat].length === 0)) {
                produse = {
                    carne: [
                        { nume: "Mici", cantitate: 2, unitate: "kg", pret: 25, am_acasa: false, notite: "" },
                        { nume: "Ceafă de porc", cantitate: 1, unitate: "buc", pret: 50, am_acasa: false, notite: "Bucată de 1 kg" },
                        { nume: "Pulpe dezosate de pui", cantitate: 1.5, unitate: "kg", pret: 16, am_acasa: false, notite: "" },
                        { nume: "Cârnați de porc", cantitate: 1, unitate: "kg", pret: 18, am_acasa: false, notite: "" }
                    ],
                    legume: [
                        { nume: "Ceapă", cantitate: 0.5, unitate: "kg", pret: 4, am_acasa: false, notite: "" },
                        { nume: "Ciuperci brune", cantitate: 1, unitate: "caserola", pret: 12, am_acasa: false, notite: "" },
                        { nume: "Lămâi", cantitate: 3, unitate: "buc", pret: 2, am_acasa: false, notite: "" },
                        { nume: "Lime", cantitate: 2, unitate: "buc", pret: 3, am_acasa: false, notite: "" },
                        { nume: "Portocale", cantitate: 1, unitate: "kg", pret: 6, am_acasa: false, notite: "" }
                    ],
                    bauturi: [
                        { nume: "Bere", cantitate: 3, unitate: "bax", pret: 35, am_acasa: false, notite: "" },
                        { nume: "Bere fără alcool", cantitate: 6, unitate: "buc", pret: 4, am_acasa: false, notite: "" },
                        { nume: "Cola", cantitate: 1, unitate: "bax", pret: 25, am_acasa: false, notite: "" },
                        { nume: "Apă (5L)", cantitate: 2, unitate: "buc", pret: 8, am_acasa: false, notite: "" },
                        { nume: "Rom", cantitate: 1, unitate: "sticla", pret: 35, am_acasa: false, notite: "" }
                    ],
                    condimente: [
                        { nume: "Pâine", cantitate: 4, unitate: "buc", pret: 4, am_acasa: false, notite: "" },
                        { nume: "Muștar", cantitate: 1, unitate: "borcan", pret: 6, am_acasa: false, notite: "" },
                        { nume: "Chipsuri/Semințe", cantitate: 3, unitate: "buc", pret: 8, am_acasa: false, notite: "" },
                        { nume: "Gheață", cantitate: 2, unitate: "kg", pret: 5, am_acasa: false, notite: "" },
                        { nume: "Carbuni", cantitate: 1, unitate: "sac", pret: 25, am_acasa: false, notite: "" },
                        { nume: "Farfurii", cantitate: 1, unitate: "set", pret: 15, am_acasa: false, notite: "Set de 50 buc" },
                        { nume: "Pahare", cantitate: 1, unitate: "set", pret: 12, am_acasa: false, notite: "" },
                        { nume: "Role bucătărie", cantitate: 1, unitate: "buc", pret: 8, am_acasa: false, notite: "" },
                        { nume: "Saci gunoi mari", cantitate: 1, unitate: "buc", pret: 12, am_acasa: false, notite: "" }
                    ]
                };
                saveCategoriesToLocalStorage(); // Salvează categoriile implicite
                saveProductsToLocalStorage(); // Salvează produsele implicite
            }


            actualizeazaToate();
            afiseazaPlanuriSalvate();

            // Atach events for budget and persons inputs
            document.getElementById('persoane').addEventListener('input', () => {
                actualizeazaBuget();
                saveProductsToLocalStorage(); // Save changes to budget/persons input
            });
            document.getElementById('buget').addEventListener('input', () => {
                actualizeazaBuget();
                saveProductsToLocalStorage(); // Save changes to budget/persons input
            });
        });
    </script>
</body>
</html>
