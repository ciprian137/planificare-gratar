<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculator Gr캒tar - Planificator Simplificat</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            color: #ecf0f1;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #f8f9fa;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            overflow: hidden;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            padding: 30px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .header h1 {
            margin: 0;
            font-size: 2.5em;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            margin-top: 10px;
            font-size: 1.1em;
            color: #bdc3c7;
        }

        .action-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .action-buttons button {
            background: #555;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .action-buttons button:hover {
            background: #777;
            transform: translateY(-2px);
        }

        .content {
            padding: 30px;
        }

        .input-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: #eceff1;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }

        .input-group input {
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
            background: white;
            color: #333;
        }

        .input-group input:focus {
            outline: none;
            border-color: #6a82fb;
            box-shadow: 0 0 0 3px rgba(106, 130, 251, 0.2);
        }

        .tables-grid-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .table-section {
            background: #eceff1;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        .table-section h3 {
            margin-top: 0;
            color: #333;
            text-align: center;
            font-size: 1.3em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #cfd8dc;
        }

        .add-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease, transform 0.2s ease;
        }

        .add-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s ease, transform 0.2s ease;
        }

        .delete-btn:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
            color: #333;
            white-space: nowrap;
        }

        th {
            background: #555;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }

        th:hover {
            background: #666;
        }

        /* Stil pentru drag-and-drop */
        td {
            /* cursor: grab;  Nu punem cursor grab pe toate celulele, doar pe r칙nd, altfel interfereaza cu input-urile */
        }
        tr[draggable="true"] {
            cursor: grab;
        }
        tr[draggable="true"]:active {
            cursor: grabbing;
        }
        tr.dragging {
            opacity: 0.5;
            background-color: #e0f2f7;
        }
        .drag-over {
            border-bottom: 2px solid #6a82fb;
        }
        /* Stil pentru tbody gol pentru drop */
        tbody.drag-over {
            border: 2px dashed #6a82fb;
            background-color: rgba(106, 130, 251, 0.1);
            min-height: 50px; /* Asigur캒 o zon캒 vizibil캒 pentru drop */
            display: block;
        }


        tr:hover {
            background: #f5f5f5;
        }

        .editable-input,
        .price-input,
        .quantity-input,
        .notes-input {
            width: calc(100% - 8px);
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
            color: #333;
        }

        .editable-input:focus,
        .price-input:focus,
        .quantity-input:focus,
        .notes-input:focus {
            outline: none;
            border-color: #6a82fb;
            box-shadow: 0 0 0 2px rgba(106, 130, 251, 0.2);
        }

        .price-input, .quantity-input {
            text-align: center;
        }

        .total-price {
            font-weight: bold;
            color: #27ae60;
        }

        .quantity {
            font-weight: bold;
            color: #e74c3c;
        }

        .budget-summary {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .budget-summary h3 {
            margin: 0 0 15px 0;
            font-size: 1.5em;
            color: #ecf0f1;
        }

        .budget-row {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 1.1em;
            color: #bdc3c7;
        }

        .remaining-budget {
            font-size: 1.3em;
            font-weight: bold;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid rgba(255,255,255,0.2);
            color: white;
        }

        .warning {
            background: #c0392b !important;
            animation: pulse 2s infinite;
            box-shadow: 0 0 15px rgba(192, 57, 43, 0.5) !important;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }

        .action-cell {
            width: 100px;
            text-align: center;
        }

        /* Stiluri pentru modal (pop-up) */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
        }

        .modal-content input[type="text"] {
            width: calc(100% - 20px);
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
        }

        .modal-content button {
            background: #5cb85c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 1em;
            transition: background 0.3s ease;
        }

        .modal-content button:hover {
            background: #4cae4c;
        }

        .modal-content .close-button {
            background: #f44336;
        }
        .modal-content .close-button:hover {
            background: #da190b;
        }

        /* Stiluri pentru Istoric Planuri Salvate */
        .history-section {
            background: #eceff1;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            margin-top: 30px;
        }

        .history-section h3 {
            margin-top: 0;
            color: #333;
            text-align: center;
            font-size: 1.3em;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #cfd8dc;
        }

        #savedPlansList {
            list-style: none;
            padding: 0;
        }

        #savedPlansList li {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            flex-wrap: wrap;
        }

        #savedPlansList li span {
            font-weight: bold;
            color: #333;
            flex-grow: 1;
            margin-right: 10px;
            white-space: normal;
        }

        #savedPlansList li .history-actions button {
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.9em;
            margin-left: 8px;
        }

        #savedPlansList li .history-actions .load-btn {
            background: #007bff;
        }
        #savedPlansList li .history-actions .load-btn:hover {
            background: #0056b3;
        }

        #savedPlansList li .history-actions .download-csv-btn {
            background: #ffc107;
            color: #333;
        }
        #savedPlansList li .history-actions .download-csv-btn:hover {
            background: #e0a800;
        }

        #savedPlansList li .history-actions .delete-btn {
            background: #dc3545;
        }
        #savedPlansList li .history-actions .delete-btn:hover {
            background: #c82333;
        }

        /* Stiluri pentru modalul de categorii */
        #categoryManagerModal .modal-content {
            text-align: left;
        }
        #categoryManagerModal h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }
        #categoryManagerModal #newCategoryName {
            width: calc(100% - 130px);
            margin-right: 10px;
            display: inline-block;
        }
        #categoryManagerModal .add-category-btn {
            background: #28a745;
            padding: 10px 15px;
        }
        #categoryManagerModal .category-list {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 5px;
            padding: 10px;
            background: #f9f9f9;
        }
        #categoryManagerModal .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        #categoryManagerModal .category-item:last-child {
            border-bottom: none;
        }
        #categoryManagerModal .category-item span {
            font-weight: normal;
            flex-grow: 1;
        }
        #categoryManagerModal .category-item input[type="text"] {
            flex-grow: 1;
            margin-right: 10px;
            border: 1px solid #ccc;
            padding: 5px;
        }
        #categoryManagerModal .category-actions button {
            padding: 5px 10px;
            font-size: 0.8em;
            margin-left: 5px;
        }
        #categoryManagerModal .category-actions .rename-btn {
            background: #ffc107;
            color: #333;
        }
        #categoryManagerModal .category-actions .delete-category-btn {
            background: #dc3545;
        }
        #categoryManagerModal .modal-buttons {
            margin-top: 20px;
            text-align: right;
        }
    </style>
</head>
<body>
    <div class="container" id="gratarPlanContainer">
        <div class="header">
            <h1>游댠 Calculator Gr캒tar - Planificator Simplificat 游댠</h1>
            <p>Gestioneaz캒-탵i lista de gr캒tar 칥n timp real 탳i salveaz캒-탵i planurile!</p>
            <div class="action-buttons">
                <button onclick="salveazaPlanCaImagine()">游닞 Salveaz캒 Plan (Imagine)</button>
                <button onclick="genereazaListaCumparaturiSiDescarca()">游 Genereaz캒 List캒 Cump캒r캒turi</button>
                <button onclick="exportaPlanCurentCSV()">游늵 Export캒 Plan Curent (CSV)</button>
                <button onclick="deschideModalSalvarePlan()">游 Salveaz캒 Plan 칥n Istoric</button>
                <button onclick="deschideModalCategorii()">丘뙖잺 Gestioneaz캒 Categorii</button>
            </div>
        </div>

        <div class="content">
            <div class="input-section">
                <div class="input-group">
                    <label for="persoane">Num캒rul de persoane:</label>
                    <input type="number" id="persoane" value="28" min="1" max="100">
                </div>
                <div class="input-group">
                    <label for="buget">Buget total (RON):</label>
                    <input type="number" id="buget" value="1200" min="0" step="0.01">
                </div>
            </div>

            <div class="tables-grid-container" id="tablesGridContainer">
                </div>

            <div class="budget-summary" id="budgetSummary">
                <h3>游늵 Sumar Buget</h3>
                <div class="budget-row">
                    <span>Buget total:</span>
                    <span id="totalBuget">1200.00 RON</span>
                </div>
                <div class="budget-row">
                    <span>Total cheltuieli (est. necesar):</span>
                    <span id="totalCheltuieli">0.00 RON</span>
                </div>
                <div class="remaining-budget">
                    <div class="budget-row">
                        <span>Bani r캒ma탳i:</span>
                        <span id="baniRamasi">1200.00 RON</span>
                    </div>
                </div>
            </div>

            <div class="history-section">
                <h3>游닄 Istoric Planuri Salvate</h3>
                <ul id="savedPlansList">
                </ul>
                <p id="noPlansMessage" style="text-align: center; color: #666;">Nu exist캒 planuri salvate. Salveaz캒 unul acum!</p>
            </div>
        </div>
    </div>

    <div id="savePlanModal" class="modal">
        <div class="modal-content">
            <h2>Salveaz캒 Planul</h2>
            <p>Introdu un nume pentru acest plan:</p>
            <input type="text" id="planNameInput" placeholder="Numele planului (ex: Gr캒tar Aniversar)">
            <button onclick="salveazaPlanInLocalStorage()">Salveaz캒</button>
            <button class="close-button" onclick="inchideModalSalvarePlan()">Anuleaz캒</button>
        </div>
    </div>

    <div id="categoryManagerModal" class="modal">
        <div class="modal-content">
            <h2>Gestioneaz캒 Categorii</h2>
            <div>
                <input type="text" id="newCategoryName" placeholder="Nume categorie nou캒">
                <button class="add-category-btn" onclick="adaugaCategorieNoua()">Adaug캒</button>
            </div>
            <div class="category-list">
                <ul id="existingCategoriesList">
                    </ul>
            </div>
            <div class="modal-buttons">
                <button class="close-button" onclick="inchideModalCategorii()">칉nchide</button>
            </div>
        </div>
    </div>

    <script>
        // Starea implicit캒 a aplica탵iei (categorii 탳i produse)
        const DEFAULT_PRODUCTS_STATE = {
            carne: [
                { nume: "Mici", cantitate: 2, unitate: "kg", pret: 25, am_acasa: false, notite: "" },
                { nume: "Ceaf캒 de porc", cantitate: 1, unitate: "buc", pret: 50, am_acasa: false, notite: "Bucat캒 de 1 kg" },
                { nume: "Pulpe dezosate de pui", cantitate: 1.5, unitate: "kg", pret: 16, am_acasa: false, notite: "" },
                { nume: "C칙rna탵i de porc", cantitate: 1, unitate: "kg", pret: 18, am_acasa: false, notite: "" }
            ],
            legume: [
                { nume: "Ceap캒", cantitate: 0.5, unitate: "kg", pret: 4, am_acasa: false, notite: "" },
                { nume: "Ciuperci brune", cantitate: 1, unitate: "caserola", pret: 12, am_acasa: false, notite: "" },
                { nume: "L캒m칙i", cantitate: 3, unitate: "buc", pret: 2, am_acasa: false, notite: "" },
                { nume: "Lime", cantitate: 2, unitate: "buc", pret: 3, am_acasa: false, notite: "" },
                { nume: "Portocale", cantitate: 1, unitate: "kg", pret: 6, am_acasa: false, notite: "" }
            ],
            bauturi: [
                { nume: "Bere", cantitate: 3, unitate: "bax", pret: 35, am_acasa: false, notite: "" },
                { nume: "Bere f캒r캒 alcool", cantitate: 6, unitate: "buc", pret: 4, am_acasa: false, notite: "" },
                { nume: "Cola", cantitate: 1, unitate: "bax", pret: 25, am_acasa: false, notite: "" },
                { nume: "Ap캒 (5L)", cantitate: 2, unitate: "buc", pret: 8, am_acasa: false, notite: "" },
                { nume: "Rom", cantitate: 1, unitate: "sticla", pret: 35, am_acasa: false, notite: "" }
            ],
            condimente: [
                { nume: "P칙ine", cantitate: 4, unitate: "buc", pret: 4, am_acasa: false, notite: "" },
                { nume: "Mu탳tar", cantitate: 1, unitate: "borcan", pret: 6, am_acasa: false, notite: "" },
                { nume: "Chipsuri/Semin탵e", cantitate: 3, unitate: "buc", pret: 8, am_acasa: false, notite: "" },
                { nume: "Ghea탵캒", cantitate: 2, unitate: "kg", pret: 5, am_acasa: false, notite: "" },
                { nume: "Carbuni", cantitate: 1, unitate: "sac", pret: 25, am_acasa: false, notite: "" },
                { nume: "Farfurii", cantitate: 1, unitate: "set", pret: 15, am_acasa: false, notite: "Set de 50 buc" },
                { nume: "Pahare", cantitate: 1, unitate: "set", pret: 12, am_acasa: false, notite: "" },
                { nume: "Role buc캒t캒rie", cantitate: 1, unitate: "buc", pret: 8, am_acasa: false, notite: "" },
                { nume: "Saci gunoi mari", cantitate: 1, unitate: "buc", pret: 12, am_acasa: false, notite: "" }
            ]
        };

        // Variabile globale pentru starea curent캒 a aplica탵iei
        let produse = {};
        let currentPersons = 28;
        let currentBudget = 1200;

        const LOCAL_STORAGE_KEY_PLAN = 'gratar_plan_curent'; // Cheia pentru a salva planul curent (produse, persoane, buget)
        const LOCAL_STORAGE_KEY_HISTORY = 'gratar_planuri_salvate'; // Cheia pentru istoric planuri

        // --- Func탵ii Utilitare pentru Stocare Local캒 ---
        function saveCurrentPlanToLocalStorage() {
            const planState = {
                produse: produse,
                persoane: parseInt(document.getElementById('persoane').value) || 0,
                buget: parseFloat(document.getElementById('buget').value) || 0
            };
            localStorage.setItem(LOCAL_STORAGE_KEY_PLAN, JSON.stringify(planState));
        }

        function loadCurrentPlanFromLocalStorage() {
            const savedPlan = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY_PLAN));
            if (savedPlan) {
                produse = savedPlan.produse;
                currentPersons = savedPlan.persoane;
                currentBudget = savedPlan.buget;
                document.getElementById('persoane').value = currentPersons;
                document.getElementById('buget').value = currentBudget;
            } else {
                // Initialize with default if no saved plan
                produse = JSON.parse(JSON.stringify(DEFAULT_PRODUCTS_STATE));
                saveCurrentPlanToLocalStorage(); // Save defaults for next load
            }

            // Ensure 'diverse' category exists if any products are left orphaned
            if (!produse['diverse']) {
                produse['diverse'] = [];
            }
        }


        // --- Func탵ii pentru Drag-and-Drop ---
        let draggingRow = null;
        let originalCategory = null;

        function handleDragStart(event, category, index) {
            draggingRow = event.target.closest('tr');
            originalCategory = category;
            draggingRow.classList.add('dragging');
            event.dataTransfer.setData('text/plain', JSON.stringify({ category, index }));
            event.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';

            const target = event.target.closest('tr') || event.target.closest('tbody');

            // Remove drag-over from all elements first
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));

            if (target && draggingRow && target !== draggingRow) {
                if (target.tagName === 'TR') {
                    const rect = target.getBoundingClientRect();
                    const y = event.clientY - rect.top;
                    if (y < rect.height / 2) {
                        target.classList.add('drag-over-top'); // Add class for top border
                    } else {
                        target.classList.add('drag-over'); // Add class for bottom border
                    }
                } else if (target.tagName === 'TBODY' && target.children.length === 0) {
                    target.classList.add('drag-over'); // If tbody is empty, highlight the tbody itself
                }
            }
        }

        function handleDragLeave(event) {
            event.target.closest('tr')?.classList.remove('drag-over', 'drag-over-top');
            event.target.closest('tbody')?.classList.remove('drag-over');
        }


        function handleDrop(event) {
            event.preventDefault();
            document.querySelectorAll('.drag-over, .drag-over-top').forEach(el => el.classList.remove('drag-over', 'drag-over-top'));

            if (!draggingRow) return;

            const data = JSON.parse(event.dataTransfer.getData('text/plain'));
            const sourceCategory = data.category;
            const sourceIndex = data.index;

            const targetRowElement = event.target.closest('tr');
            const targetTbodyElement = event.target.closest('tbody');

            let targetCategory = null;
            let targetIndex = -1;

            if (targetRowElement) {
                targetCategory = targetRowElement.dataset.category;
                const rows = Array.from(targetTbodyElement.children);
                targetIndex = rows.indexOf(targetRowElement);

                // Adjust targetIndex if dropping above the target row
                const rect = targetRowElement.getBoundingClientRect();
                const y = event.clientY - rect.top;
                if (y < rect.height / 2) {
                    // Dropping before the target row
                } else {
                    // Dropping after the target row
                    targetIndex += 1;
                }
            } else if (targetTbodyElement) {
                targetCategory = targetTbodyElement.closest('.table-section').querySelector('h3').textContent.split(' ')[0].toLowerCase();
                targetIndex = produse[targetCategory].length; // Drop at the end of the tbody
            }

            if (targetCategory === null || targetIndex === -1) {
                // Invalid drop target
                draggingRow.classList.remove('dragging');
                draggingRow = null;
                originalCategory = null;
                return;
            }

            if (sourceCategory === targetCategory) {
                // Moving within the same category
                const [movedProduct] = produse[sourceCategory].splice(sourceIndex, 1);
                produse[targetCategory].splice(targetIndex, 0, movedProduct);
            } else {
                // Moving between different categories
                const [movedProduct] = produse[sourceCategory].splice(sourceIndex, 1);
                produse[targetCategory].splice(targetIndex, 0, movedProduct);
            }

            draggingRow.classList.remove('dragging');
            draggingRow = null;
            originalCategory = null;

            actualizeazaToate();
            saveCurrentPlanToLocalStorage();
        }

        function attachDragDropListeners() {
            const allRows = document.querySelectorAll('tr[draggable="true"]');
            allRows.forEach(row => {
                row.removeEventListener('dragstart', handleDragStart); // Remove old listeners to prevent duplicates
                row.removeEventListener('dragover', handleDragOver);
                row.removeEventListener('dragleave', handleDragLeave);
                row.removeEventListener('drop', handleDrop);
                row.removeEventListener('dragenter', (e) => e.preventDefault());

                // Re-add with current context
                const category = row.dataset.category;
                const index = parseInt(row.dataset.index);
                row.addEventListener('dragstart', (e) => handleDragStart(e, category, index));
                row.addEventListener('dragover', handleDragOver);
                row.addEventListener('dragleave', handleDragLeave);
                row.addEventListener('drop', handleDrop);
                row.addEventListener('dragenter', (e) => e.preventDefault());
            });

            const allTbodies = document.querySelectorAll('.table-section tbody');
            allTbodies.forEach(tbody => {
                tbody.removeEventListener('dragover', handleDragOver); // Remove old listeners
                tbody.removeEventListener('dragleave', handleDragLeave);
                tbody.removeEventListener('drop', handleDrop);
                tbody.removeEventListener('dragenter', (e) => e.preventDefault());

                tbody.addEventListener('dragover', handleDragOver);
                tbody.addEventListener('dragleave', handleDragLeave);
                tbody.addEventListener('drop', handleDrop);
                tbody.addEventListener('dragenter', (e) => e.preventDefault());
            });
        }


        // --- Func탵ii pentru CRUD Categorii ---
        function deschideModalCategorii() {
            document.getElementById('categoryManagerModal').style.display = 'flex';
            afiseazaCategoriiExistente();
        }

        function inchideModalCategorii() {
            document.getElementById('categoryManagerModal').style.display = 'none';
        }

        function afiseazaCategoriiExistente() {
            const listElement = document.getElementById('existingCategoriesList');
            listElement.innerHTML = '';
            const currentCategories = Object.keys(produse);

            currentCategories.forEach(cat => {
                const li = document.createElement('li');
                li.className = 'category-item';
                
                const span = document.createElement('span');
                span.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
                li.appendChild(span);

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'category-actions';

                const renameInput = document.createElement('input');
                renameInput.type = 'text';
                renameInput.value = cat;
                renameInput.style.display = 'none';

                const renameBtn = document.createElement('button');
                renameBtn.textContent = 'Redenume탳te';
                renameBtn.className = 'rename-btn';
                renameBtn.onclick = () => {
                    if (renameInput.style.display === 'none') {
                        span.style.display = 'none';
                        renameInput.style.display = 'inline-block';
                        renameInput.focus();
                    } else {
                        redenumesteCategorie(cat, renameInput.value);
                    }
                };

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = '탲terge';
                deleteBtn.className = 'delete-category-btn';
                deleteBtn.onclick = () => stergeCategorie(cat);

                actionsDiv.appendChild(renameInput);
                actionsDiv.appendChild(renameBtn);
                
                // Prevenim 탳tergerea categoriilor implicite dac캒 nu sunt goale.
                // Categoria 'diverse' poate fi 탳ters캒 dac캒 e goal캒, dar e implicit캒 pt. mutare.
                const isDefaultCategory = ['carne', 'legume', 'bauturi', 'condimente'].includes(cat);
                const isDiverseCategory = cat === 'diverse';

                if (!(isDefaultCategory && produse[cat].length > 0) && !(isDiverseCategory && produse[cat].length > 0)) {
                     actionsDiv.appendChild(deleteBtn);
                }


                li.appendChild(actionsDiv);
                listElement.appendChild(li);
            });
        }

        function adaugaCategorieNoua() {
            const newCategoryNameInput = document.getElementById('newCategoryName');
            let newCategoryName = newCategoryNameInput.value.trim().toLowerCase();

            if (!newCategoryName) {
                alert('Numele categoriei nu poate fi gol!');
                return;
            }
            if (newCategoryName.includes(' ')) {
                newCategoryName = newCategoryName.replace(/\s+/g, '-');
                alert(`Numele categoriei a fost ajustat la "${newCategoryName}" (f캒r캒 spa탵ii).`);
            }
            if (produse[newCategoryName]) {
                alert('Aceast캒 categorie exist캒 deja!');
                return;
            }

            produse[newCategoryName] = [];
            newCategoryNameInput.value = '';
            saveCurrentPlanToLocalStorage();
            actualizeazaToate();
            afiseazaCategoriiExistente();
        }

        function redenumesteCategorie(oldName, newName) {
            newName = newName.trim().toLowerCase();
            if (!newName) {
                alert('Numele categoriei nu poate fi gol!');
                afiseazaCategoriiExistente();
                return;
            }
            if (newName.includes(' ')) {
                newName = newName.replace(/\s+/g, '-');
            }
            if (oldName === newName) {
                afiseazaCategoriiExistente();
                return;
            }
            if (produse[newName]) {
                alert('O categorie cu acest nume exist캒 deja!');
                afiseazaCategoriiExistente();
                return;
            }

            produse[newName] = produse[oldName];
            delete produse[oldName];

            saveCurrentPlanToLocalStorage();
            actualizeazaToate();
            afiseazaCategoriiExistente();
        }

        function stergeCategorie(categoryToDelete) {
            if (!confirm(`Sigur vrei s캒 탳tergi categoria "${categoryToDelete}"? Produsele din aceast캒 categorie vor fi mutate 칥n "diverse".`)) {
                return;
            }

            const defaultCategory = 'diverse';
            if (!produse[defaultCategory]) {
                produse[defaultCategory] = [];
            }

            if (produse[categoryToDelete]) {
                produse[defaultCategory].push(...produse[categoryToDelete]);
                delete produse[categoryToDelete];
            }

            saveCurrentPlanToLocalStorage();
            actualizeazaToate();
            afiseazaCategoriiExistente();
        }

        // --- Func탵ii Modificate pentru a Suporta Categorii Dinamice ---
        function actualizeazaToate() {
            const tablesGridContainer = document.getElementById('tablesGridContainer');
            tablesGridContainer.innerHTML = '';

            const currentCategories = Object.keys(produse).sort(); // Sorteaz캒 alfabetic categoriile pentru consisten탵캒

            currentCategories.forEach(category => {
                const section = document.createElement('div');
                section.className = 'table-section';
                
                const categoryDisplayName = category.charAt(0).toUpperCase() + category.slice(1);

                section.innerHTML = `
                    <h3>${categoryDisplayName} <button class="add-btn" onclick="adaugaProdus('${category}')">+ Adaug캒</button></h3>
                    <table id="${category}Table">
                        <thead>
                            <tr>
                                <th onclick="sorteazaTabel('${category}', 'nume')">Produs</th>
                                <th onclick="sorteazaTabel('${category}', 'cantitate')">Cantitate</th>
                                <th onclick="sorteazaTabel('${category}', 'unitate')">Unitate</th>
                                <th onclick="sorteazaTabel('${category}', 'pret')">Pre탵/Unitate (RON)</th>
                                <th>Am Acas캒</th>
                                <th>Noti탵e</th>
                                <th>Total (RON)</th>
                                <th>Ac탵iuni</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                `;
                tablesGridContainer.appendChild(section);
                actualizeazaTabela(`${category}Table`, produse[category], category);
            });
            actualizeazaBuget();
            attachDragDropListeners(); // Re-ata탳eaz캒 evenimentele de drag-and-drop
        }

        function actualizeazaTabela(tabelId, produse_categorie, categoria) {
            const tabel = document.getElementById(tabelId);
            if (!tabel) return;
            const tbody = tabel.querySelector('tbody');
            if (!tbody) return;

            tbody.innerHTML = '';

            produse_categorie.forEach((produs, index) => {
                const totalProdusCalculat = (produs.cantitate * produs.pret).toFixed(2); // Calculeaza totalul cu 2 zecimale

                const row = tbody.insertRow();
                row.setAttribute('draggable', true);
                row.dataset.category = categoria;
                row.dataset.index = index; // Adaug캒 indexul produsului 칥n r칙nd

                row.innerHTML = `
                    <td><input type="text" class="editable-input" value="${produs.nume}" onchange="actualizeazaProprietate('${categoria}', ${index}, 'nume', this.value)"></td>
                    <td><input type="number" class="quantity-input" value="${produs.cantitate}" step="0.01" onchange="actualizeazaProprietate('${categoria}', ${index}, 'cantitate', parseFloat(this.value) || 0)"></td>
                    <td><input type="text" class="editable-input" value="${produs.unitate}" onchange="actualizeazaProprietate('${categoria}', ${index}, 'unitate', this.value)"></td>
                    <td><input type="number" class="price-input" value="${produs.pret}" step="0.01" onchange="actualizeazaProprietate('${categoria}', ${index}, 'pret', parseFloat(this.value) || 0)"></td>
                    <td><input type="checkbox" onchange="actualizeazaProprietate('${categoria}', ${index}, 'am_acasa', this.checked)" ${produs.am_acasa ? 'checked' : ''}></td>
                    <td><input type="text" class="notes-input" value="${produs.notite}" onchange="actualizeazaProprietate('${categoria}', ${index}, 'notite', this.value)"></td>
                    <td class="total-price">${totalProdusCalculat} RON</td>
                    <td class="action-cell"><button class="delete-btn" onclick="stergeProdus('${categoria}', ${index})">탲terge</button></td>
                `;
            });
        }

        function calculeazaTotalProdus(cantitate, pret) {
            return (cantitate * pret); // Returneaz캒 valoarea numeric캒, formatarea se face la afi탳are
        }

        function actualizeazaProprietate(categoria, index, proprietate, valoareNoua) {
            if (!produse[categoria] || !produse[categoria][index]) {
                console.error("Produsul nu a putut fi g캒sit:", categoria, index);
                return;
            }
            produse[categoria][index][proprietate] = valoareNoua;
            actualizeazaToate();
            saveCurrentPlanToLocalStorage(); // Salveaz캒 la fiecare modificare de proprietate
        }

        function adaugaProdus(categoria) {
            const produs = {
                nume: "Produs nou",
                cantitate: 1,
                unitate: "buc",
                pret: 1,
                am_acasa: false,
                notite: ""
            };
            if (!produse[categoria]) { // Asigur캒-te c캒 categoria exist캒
                produse[categoria] = [];
            }
            produse[categoria].push(produs);
            actualizeazaToate();
            saveCurrentPlanToLocalStorage();
        }

        function stergeProdus(categoria, index) {
            if (confirm('Sigur vrei s캒 탳tergi acest produs?')) {
                produse[categoria].splice(index, 1);
                actualizeazaToate();
                saveCurrentPlanToLocalStorage();
            }
        }

        function calculeazaTotalCheltuieli() {
            let total = 0;
            Object.values(produse).forEach(categorieProduse => {
                categorieProduse.forEach(produs => {
                    if (!produs.am_acasa) {
                        total += produs.cantitate * produs.pret;
                    }
                });
            });
            return total;
        }

        function actualizeazaBuget() {
            const bugetTotal = parseFloat(document.getElementById('buget').value) || 0;
            const totalCheltuieli = calculeazaTotalCheltuieli();
            const baniRamasi = bugetTotal - totalCheltuieli;

            document.getElementById('totalBuget').textContent = `${bugetTotal.toFixed(2)} RON`;
            document.getElementById('totalCheltuieli').textContent = `${totalCheltuieli.toFixed(2)} RON`;
            document.getElementById('baniRamasi').textContent = `${baniRamasi.toFixed(2)} RON`;

            const budgetSummary = document.getElementById('budgetSummary');
            if (baniRamasi < 0) {
                budgetSummary.classList.add('warning');
            } else {
                budgetSummary.classList.remove('warning');
            }
        }

        function sorteazaTabel(categoria, cheie) {
            produse[categoria].sort((a, b) => {
                if (typeof a[cheie] === 'string') {
                    return a[cheie].localeCompare(b[cheie]);
                }
                return a[cheie] - b[cheie];
            });
            actualizeazaTabela(categoria + 'Table', produse[categoria], categoria);
            saveCurrentPlanToLocalStorage(); // Salveaz캒 dup캒 sortare
        }

        // Func탵ia pentru salvarea planului ca imagine
        function salveazaPlanCaImagine() {
            const element = document.getElementById('gratarPlanContainer');

            const options = {
                scale: 2,
                useCORS: true,
                logging: false,
                backgroundColor: '#f8f9fa'
            };

            html2canvas(element, options).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const a = document.createElement('a');
                const date = new Date();
                const filename = `plan_gratar_${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}_${date.getHours().toString().padStart(2, '0')}${date.getMinutes().toString().padStart(2, '0')}.png`;
                a.href = imgData;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                alert('Planul a fost salvat ca imagine!');
            }).catch(error => {
                console.error('Eroare la salvarea imaginii:', error);
                alert('A ap캒rut o eroare la salvarea planului ca imagine. Te rog s캒 칥ncerci din nou.');
            });
        }

        // Func탵ia pentru generarea 탳i desc캒rcarea listei de cump캒r캒turi (TXT)
        function genereazaListaCumparaturiSiDescarca() {
            const nr_persoane = parseInt(document.getElementById('persoane').value) || 0;

            const lista = {};
            let totalLista = 0;
            let outputText = "--- Lista de Cump캒r캒turi Gr캒tar ---\n\n";
            outputText += `Num캒r persoane estimate: ${nr_persoane}\n\n`;

            Object.values(produse).forEach(categorie => {
                categorie.forEach(produs => {
                    if (!produs.am_acasa) {
                        const cantitateNecesara = produs.cantitate;
                        const pretTotalProdus = cantitateNecesara * produs.pret;

                        if (lista[produs.nume]) {
                            lista[produs.nume].cantitate += cantitateNecesara;
                            lista[produs.nume].pretTotal += pretTotalProdus;
                        } else {
                            lista[produs.nume] = {
                                cantitate: cantitateNecesara,
                                unitate: produs.unitate,
                                pretTotal: pretTotalProdus,
                                notite: produs.notite
                            };
                        }
                        totalLista += pretTotalProdus;
                    }
                });
            });

            for (const numeProdus in lista) {
                const item = lista[numeProdus];
                outputText += `- ${numeProdus}: ${item.cantitate.toFixed(2)} ${item.unitate} (${item.pretTotal.toFixed(2)} RON)\n`;
                if (item.notite) {
                    outputText += `  (Noti탵e: ${item.notite})\n`;
                }
            }

            outputText += `\n--------------------------------------\n`;
            outputText += `Total estimat pentru cump캒r캒turi: ${totalLista.toFixed(2)} RON\n`;
            outputText += `--------------------------------------\n`;

            const blob = new Blob([outputText], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const date = new Date();
            const filename = `lista_cumparaturi_gratar_${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}.txt`;
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Functii pentru Istoric Planuri si CSV
        function deschideModalSalvarePlan() {
            document.getElementById('savePlanModal').style.display = 'flex';
            document.getElementById('planNameInput').value = '';
            document.getElementById('planNameInput').focus();
        }

        function inchideModalSalvarePlan() {
            document.getElementById('savePlanModal').style.display = 'none';
        }

        function salveazaPlanInLocalStorage() {
            const planName = document.getElementById('planNameInput').value.trim();
            if (!planName) {
                alert('Te rog introdu un nume pentru plan!');
                return;
            }

            const savedPlans = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY_HISTORY) || '[]');
            const timestamp = new Date().toISOString();

            const currentPlanState = {
                name: planName,
                date: new Date().toLocaleString('ro-RO'),
                timestamp: timestamp,
                persoane: parseInt(document.getElementById('persoane').value) || 0,
                buget: parseFloat(document.getElementById('buget').value) || 0,
                produse: JSON.parse(JSON.stringify(produse))
            };

            savedPlans.push(currentPlanState);
            localStorage.setItem(LOCAL_STORAGE_KEY_HISTORY, JSON.stringify(savedPlans));
            inchideModalSalvarePlan();
            afiseazaPlanuriSalvate();
            alert(`Planul "${planName}" a fost salvat!`);
        }

        function afiseazaPlanuriSalvate() {
            const savedPlans = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY_HISTORY) || '[]');
            const listElement = document.getElementById('savedPlansList');
            const noPlansMessage = document.getElementById('noPlansMessage');
            listElement.innerHTML = '';

            if (savedPlans.length === 0) {
                noPlansMessage.style.display = 'block';
                return;
            } else {
                noPlansMessage.style.display = 'none';
            }

            savedPlans.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            savedPlans.forEach((plan, index) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${plan.name} <br> <small>${plan.date}</small></span>
                    <div class="history-actions">
                        <button class="load-btn" onclick="incarcaPlan('${plan.timestamp}')">칉ncarc캒</button>
                        <button class="download-csv-btn" onclick="exportaPlanCSV('${plan.timestamp}')">Desc캒rcare CSV</button>
                        <button class="delete-btn" onclick="stergePlan('${plan.timestamp}')">탲terge</button>
                    </div>
                `;
                listElement.appendChild(li);
            });
        }

        function incarcaPlan(timestamp) {
            const savedPlans = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY_HISTORY) || '[]');
            const planToLoad = savedPlans.find(p => p.timestamp === timestamp);

            if (planToLoad && confirm(`Sigur vrei s캒 칥ncarci planul "${planToLoad.name}"? Modific캒rile curente nesalvate se vor pierde.`)) {
                document.getElementById('persoane').value = planToLoad.persoane;
                document.getElementById('buget').value = planToLoad.buget;
                produse = JSON.parse(JSON.stringify(planToLoad.produse));
                actualizeazaToate();
                saveCurrentPlanToLocalStorage(); // Salveaz캒 planul 칥nc캒rcat ca plan curent
                alert(`Planul "${planToLoad.name}" a fost 칥nc캒rcat!`);
            }
        }

        function stergePlan(timestamp) {
            if (confirm('Sigur vrei s캒 탳tergi acest plan din istoric?')) {
                let savedPlans = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY_HISTORY) || '[]');
                savedPlans = savedPlans.filter(p => p.timestamp !== timestamp);
                localStorage.setItem(LOCAL_STORAGE_KEY_HISTORY, JSON.stringify(savedPlans));
                afiseazaPlanuriSalvate();
                alert('Plan 탳ters din istoric.');
            }
        }

        // Func탵ia care genereaz캒 con탵inutul CSV
        function generateCSVContent(planData) {
            let csvContent = "";

            // Antetul CSV
            const headers = ["Categorie", "Produs", "Cantitate", "Unitate", "Pret/Unitate (RON)", "Am Acasa", "Notite", "Total (RON)"];
            csvContent += headers.join(",") + "\n"; // Folosim virgula ca separator

            // Adaug캒 datele pentru fiecare categorie
            for (const category in planData.produse) {
                planData.produse[category].forEach(produs => {
                    const totalProdus = (produs.cantitate * produs.pret).toFixed(2);
                    const row = [
                        category,
                        `"${produs.nume.replace(/"/g, '""')}"`,
                        produs.cantitate,
                        produs.unitate,
                        produs.pret,
                        produs.am_acasa ? "Da" : "Nu",
                        `"${produs.notite.replace(/"/g, '""')}"`,
                        totalProdus
                    ];
                    csvContent += row.join(",") + "\n";
                });
            }

            // Adaug캒 sumarul bugetului la final
            csvContent += "\n\n";
            csvContent += "Sumar Buget\n";
            csvContent += `Data:,${planData.date || 'N/A'}\n`;
            csvContent += `Nume plan:,${planData.name || 'Plan Curent'}\n`;
            csvContent += `Numar persoane:,${planData.persoane}\n`;
            csvContent += `Buget total:,${planData.buget.toFixed(2)} RON\n`;
            const totalCheltuieli = Object.values(planData.produse).flat().reduce((sum, p) => sum + (p.am_acasa ? 0 : p.cantitate * p.pret), 0);
            csvContent += `Total cheltuieli (est. necesar):,${totalCheltuieli.toFixed(2)} RON\n`;
            csvContent += `Bani ramasi:,${(planData.buget - totalCheltuieli).toFixed(2)} RON\n`;

            return csvContent;
        }

        // Func탵ia pentru exportul planului curent 칥n CSV
        function exportaPlanCurentCSV() {
            const currentPlanState = {
                name: "Plan Curent",
                date: new Date().toLocaleString('ro-RO'),
                persoane: parseInt(document.getElementById('persoane').value) || 0,
                buget: parseFloat(document.getElementById('buget').value) || 0,
                produse: JSON.parse(JSON.stringify(produse))
            };
            const csv = generateCSVContent(currentPlanState);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const date = new Date();
            const filename = `plan_gratar_curent_${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}.csv`;
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('Planul curent a fost exportat 칥n CSV!');
        }

        // Func탵ia pentru exportul unui plan din istoric 칥n CSV
        function exportaPlanCSV(timestamp) {
            const savedPlans = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY_HISTORY) || '[]');
            const planToExport = savedPlans.find(p => p.timestamp === timestamp);

            if (planToExport) {
                const csv = generateCSVContent(planToExport);
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const filename = `plan_gratar_${planToExport.name.replace(/[^a-z0-9]/gi, '_')}_${new Date(planToExport.timestamp).toLocaleDateString('ro-RO').replace(/\./g, '-')}.csv`;
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                alert(`Planul "${planToExport.name}" a fost exportat 칥n CSV!`);
            } else {
                alert('Eroare: Planul nu a fost g캒sit 칥n istoric.');
            }
        }


        // Ini탵ializare la 칥nc캒rcarea paginii
        document.addEventListener('DOMContentLoaded', () => {
            loadCurrentPlanFromLocalStorage(); // 칉nc캒rc캒m starea curent캒 (inclusiv produse 탳i categorii)
            actualizeazaToate(); // Afi탳eaz캒 toate tabelele cu datele 칥nc캒rcate
            afiseazaPlanuriSalvate(); // Afi탳eaz캒 istoricul planurilor

            // Atach events for budget and persons inputs
            document.getElementById('persoane').addEventListener('input', () => {
                actualizeazaBuget();
                saveCurrentPlanToLocalStorage();
            });
            document.getElementById('buget').addEventListener('input', () => {
                actualizeazaBuget();
                saveCurrentPlanToLocalStorage();
            });
        });
    </script>
</body>
</html>
